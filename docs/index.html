<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Cloud Pipelines</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Cloud Pipelines</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#five-second-introduction">1.1. Five-second Introduction</a></li>
<li><a href="#five-minute-introduction">1.2. Five-minute Introduction</a>
<ul class="sectlevel3">
<li><a href="#how-to-use-it">1.2.1. How to Use It</a></li>
<li><a href="#how-it-works">1.2.2. How It Works</a></li>
<li><a href="#centralized-pipeline-creation">1.2.3. Centralized Pipeline Creation</a></li>
<li><a href="#a-pipeline-for-each-repository">1.2.4. A Pipeline for Each Repository</a></li>
</ul>
</li>
<li><a href="#the-flow">1.3. The Flow</a></li>
<li><a href="#vocabulary">1.4. Vocabulary</a>
<ul class="sectlevel3">
<li><a href="#environments">1.4.1. Environments</a></li>
<li><a href="#tests">1.4.2. Tests</a></li>
<li><a href="#testing-against-stubs">1.4.3. Testing against Stubs</a></li>
<li><a href="#general-view">1.4.4. General View</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#customizing-the-project">2. Customizing the Project</a>
<ul class="sectlevel2">
<li><a href="#customization-overriding-scripts">2.1. Overriding Scripts</a></li>
<li><a href="#customization-overriding-pipelines">2.2. Overriding Pipelines</a></li>
</ul>
</li>
<li><a href="#step-by-step-cloud-foundry-migration">3. Step-by-step Cloud Foundry Migration</a>
<ul class="sectlevel2">
<li><a href="#preview">3.1. Preview</a></li>
<li><a href="#introduction-2">3.2. Introduction</a></li>
<li><a href="#sample-application-initial-state">3.3. Sample Application&#8201;&#8212;&#8201;Initial State</a></li>
<li><a href="#sample-application-end-state">3.4. Sample Application&#8201;&#8212;&#8201;End State</a></li>
<li><a href="#tutorial-toolset">3.5. Tutorial&#8201;&#8212;&#8201;Toolset</a></li>
<li><a href="#tutorial-overview">3.6. Tutorial&#8201;&#8212;&#8201;Overview</a></li>
<li><a href="#tutorial-step-by-step">3.7. Tutorial&#8201;&#8212;&#8201;Step-by-step</a>
<ul class="sectlevel3">
<li><a href="#tutorial-prep">3.7.1. Prep: Before you begin</a></li>
<li><a href="#tutorial-stage-one">3.7.2. Stage One: Scaffolding</a>
<ul class="sectlevel4">
<li><a href="#1-1-create-github-branches">1.1 Create GitHub Branches</a></li>
<li><a href="#1-2-add-maven-wrapper">1.2 Add Maven Wrapper</a></li>
<li><a href="#1-3-create-the-bintray-maven-repository-package">1.3 Create the Bintray Maven Repository Package</a></li>
<li><a href="#1-4-configure-distribution-management-by-using-the-bintray-maven-repository">1.4 Configure Distribution Management by Using the Bintray Maven Repository</a></li>
<li><a href="#1-5-push-changes-to-github">1.5 Push Changes to GitHub</a></li>
<li><a href="#1-6-add-a-cloud-pipelines-credentials-file">1.6 Add a Cloud Pipelines Credentials File</a></li>
<li><a href="#1-7-set-the-concourse-pipeline">1.7 Set the Concourse Pipeline</a></li>
<li><a href="#1-8-add-cloud-foundry-manifest">1.8 Add Cloud Foundry manifest</a></li>
<li><a href="#1-9-add-the-cloud-pipelines-manifest">1.9 Add the Cloud Pipelines Manifest</a></li>
<li><a href="#1-10-push-changes-to-github">1.10 Push changes to GitHub</a></li>
<li><a href="#1-11-create-cloud-foundry-orgs-and-spaces">1.11 Create Cloud Foundry Orgs and Spaces</a></li>
<li><a href="#1-12-create-cloud-foundry-stage-and-prod-service-instances">1.12 Create Cloud Foundry Stage and Prod Service Instances</a></li>
<li><a href="#1-13-update-the-cloud-pipelines-credentials-file">1.13 Update the Cloud Pipelines Credentials File</a></li>
<li><a href="#1-14-update-the-concourse-pipeline-with-updated-credentials-files">1.14 Update the Concourse Pipeline with Updated Credentials Files</a></li>
<li><a href="#stage-one-recap-and-next-steps">Stage One Recap and Next Steps</a></li>
</ul>
</li>
<li><a href="#tutorial-stage-two">3.7.3. Stage Two: Tests</a>
<ul class="sectlevel4">
<li><a href="#2-1-add-maven-profiles">2.1 Add Maven Profiles</a></li>
<li><a href="#2-2-add-and-organize-tests">2.2 Add and Organize Tests</a></li>
<li><a href="#2-3-enable-database-versioning">2.3 Enable Database Versioning</a></li>
<li><a href="#2-4-push-changes-to-github">2.4 Push Changes to GitHub</a></li>
<li><a href="#2-5-re-run-the-pipelines">2.5 Re-run the Pipelines</a></li>
<li><a href="#stage-two-recap-and-next-steps">Stage Two Recap and Next Steps</a></li>
</ul>
</li>
<li><a href="#tutorial-stage-three">3.7.4. Stage Three: Contracts</a>
<ul class="sectlevel4">
<li><a href="#3-1-create-a-contract">3.1 Create a Contract</a></li>
<li><a href="#3-2-create-a-base-class-for-contract-tests">3.2 Create a Base Class for Contract Tests</a></li>
<li><a href="#3-3-enable-automated-contract-based-testing">3.3 Enable Automated Contract-based Testing</a></li>
<li><a href="#3-4-enable-backward-compatibility-api-check">3.4 Enable backward compatibility API check</a></li>
<li><a href="#3-5-push-changes-to-github">3.5 Push Changes to GitHub</a></li>
<li><a href="#3-6-re-run-the-code-fortune-service-code-pipeline">3.6 Re-run the <code>fortune-service</code> Pipeline</a></li>
<li><a href="#3-7-enable-stubs-for-integration-tests">3.7 Enable Stubs for Integration Tests</a></li>
<li><a href="#3-8-enable-stubs-for-smoke-tests">3.8 Enable Stubs for Smoke Tests</a></li>
<li><a href="#3-9-push-changes-to-github">3.9 Push Changes to GitHub</a></li>
<li><a href="#stage-three-recap">Stage Three Recap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#conclusion">3.8. Conclusion</a></li>
</ul>
</li>
<li><a href="#concourse-pipeline-cf">4. Concourse Pipeline (Cloud Foundry)</a>
<ul class="sectlevel2">
<li><a href="#concourse-pipeline-step-by-step-cf">4.1. Step-by-step</a>
<ul class="sectlevel3">
<li><a href="#concourse-fork-cf">4.1.1. Fork Repositories</a></li>
<li><a href="#concourse-start-cf">4.1.2. Start Concourse and Artifactory</a>
<ul class="sectlevel4">
<li><a href="#concourse-deploy-cf">Deploy the infra JARs to Artifactory</a></li>
</ul>
</li>
<li><a href="#concourse-pcfdev-cf">4.1.3. Start PCF Dev</a></li>
<li><a href="#concourse-fly-cf">4.1.4. Setup the <code>fly</code> CLI</a></li>
<li><a href="#concourse-credentials-cf">4.1.5. Set up Your <code>credentials.yml</code> File</a></li>
<li><a href="#concourse-build-cf">4.1.6. Build the Pipeline</a></li>
<li><a href="#concourse-run-cf">4.1.7. Run the <code>github-webhook</code> Pipeline</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#concourse-pipeline-k8s">5. Concourse Pipeline (Kubernetes)</a>
<ul class="sectlevel2">
<li><a href="#step-by-step-k8s">5.1. Step-by-step</a>
<ul class="sectlevel3">
<li><a href="#fork-repos-k8s">5.1.1. Fork Repositories</a></li>
</ul>
</li>
<li><a href="#concourse-start-k8s">5.2. Concourse in K8S (Kubernetes)</a>
<ul class="sectlevel3">
<li><a href="#deploying-artifactory-to-k8s">5.2.1. Deploying Artifactory to K8S</a></li>
<li><a href="#concourse-pipeline-fly-k8s">5.2.2. Setup the <code>fly</code> CLI</a></li>
<li><a href="#concourse-pipeline-credentials-k8s">5.2.3. Setup your <code>credentials.yml</code></a></li>
<li><a href="#concourse-pipeline-build-k8s">5.2.4. Build the pipeline</a></li>
<li><a href="#concourse-pipeline-run-k8s">5.2.5. Run the <code>github-webhook</code> Pipeline</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#kubernetes-setup">6. Kubernetes Setup</a>
<ul class="sectlevel2">
<li><a href="#kubernetes-cli-installation">6.1. Kubernetes CLI Installation</a>
<ul class="sectlevel3">
<li><a href="#kubernetes-cli-script">6.1.1. Script Installation</a></li>
<li><a href="#kubernetes-cli-manual">6.1.2. Manual Installation</a>
<ul class="sectlevel4">
<li><a href="#example-for-osx">Example for OSX</a></li>
<li><a href="#example-for-linux">Example for Linux</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#start-minikube-k8s">6.2. Kubernetes Cluster Setup</a>
<ul class="sectlevel3">
<li><a href="#kubernetes-minikube-script">6.2.1. Script Installation</a></li>
<li><a href="#kubernetes-minikube-manual">6.2.2. Manual Installation</a>
<ul class="sectlevel4">
<li><a href="#example-for-osx-2">Example for OSX</a></li>
</ul>
</li>
<li><a href="#example-for-linux-2">6.2.3. Example for Linux</a></li>
</ul>
</li>
<li><a href="#run-minikube">6.3. Run Minikube</a></li>
<li><a href="#certificates-and-workers">6.4. Certificates and Workers</a>
<ul class="sectlevel3">
<li><a href="#minikube-certificates-and-workers">6.4.1. Minikube Certificates and Workers</a></li>
<li><a href="#manual-certificates-and-workers-setup">6.4.2. Manual Certificates and Workers Setup</a></li>
</ul>
</li>
<li><a href="#generate-minikube-namespaces">6.5. Generate Minikube Namespaces</a></li>
</ul>
</li>
<li><a href="#the-demo-setup-cloud-foundry">7. The demo setup (Cloud Foundry)</a>
<ul class="sectlevel2">
<li><a href="#deploying-production-applications-to-pcf-dev">7.1. Deploying Production Applications to PCF Dev</a></li>
<li><a href="#running-prometheus-on-cf">7.2. Running Prometheus on CF</a></li>
<li><a href="#running-grafana-on-cf">7.3. Running Grafana on CF</a></li>
</ul>
</li>
<li><a href="#the-demo-setup-kubernetes">8. The demo setup (Kubernetes)</a>
<ul class="sectlevel2">
<li><a href="#deploying-production-applications-to-minikube">8.1. Deploying Production Applications to Minikube</a></li>
<li><a href="#running-prometheus-on-kubernetes">8.2. Running Prometheus on Kubernetes</a></li>
<li><a href="#running-grafana-on-kubernetes">8.3. Running Grafana on Kubernetes</a></li>
</ul>
</li>
<li><a href="#building-the-project">9. Building the Project</a>
<ul class="sectlevel2">
<li><a href="#building-project-setup">9.1. Project Setup</a></li>
<li><a href="#building-prerequisites">9.2. Prerequisites</a></li>
<li><a href="#building-bats-submodules">9.3. Bats Submodules</a></li>
<li><a href="#building-build-and-test">9.4. Build and test</a></li>
<li><a href="#building-generate-documentation">9.5. Generate Documentation</a></li>
</ul>
</li>
<li><a href="#building-making-a-release">10. Releasing the Project</a>
<ul class="sectlevel2">
<li><a href="#publishing-a-docker-image">10.1. Publishing A Docker Image</a></li>
</ul>
</li>
<li><a href="#building-ci-worker-prerequisites">11. CI Server Worker Prerequisites</a></li>
<li><a href="#concourse-faq">12. Concourse FAQ</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Spring, Spring Boot, and Spring Cloud are tools that let developers speed up the
time of creating new business features. It is common knowledge, however, that the
feature is only valuable if it is in production. That is why companies
spend a lot of time and resources on building their own deployment pipelines.</p>
</div>
<div class="paragraph">
<p>This project tries to solve the following problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creation of a common deployment pipeline.</p>
</li>
<li>
<p>Propagation of good testing and deployment practices.</p>
</li>
<li>
<p>Reducing the time required to deploy a feature to production.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A common way of running, configuring, and deploying applications lowers support costs
and time needed by new developers to blend in when they change projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the rationale
behind the opinionated pipeline. We go through each deployment
step and describe it in detail.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You do not need to use all the pieces of Cloud Pipelines. You
can (and should) gradually migrate your applications to use those pieces of
Cloud Pipelines that you think best suit your needs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="five-second-introduction">1.1. Five-second Introduction</h3>

</div>
<div class="sect2">
<h3 id="five-minute-introduction">1.2. Five-minute Introduction</h3>
<div class="sect3">
<h4 id="how-to-use-it">1.2.1. How to Use It</h4>

</div>
<div class="sect3">
<h4 id="how-it-works">1.2.2. How It Works</h4>
<div class="paragraph">
<p>As the following image shows, Cloud Pipelines contains logic to generate a
pipeline and the runtime to execute pipeline steps.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/how.png" alt="how">
</div>
<div class="title">Figure 1. How Cloud Pipelines works</div>
</div>
<div class="paragraph">
<p>Once a pipeline is created (for example, by using the Jenkins Job DSL or from a Concourse
templated pipeline), when the jobs are ran, they clone or download Cloud Pipelines
code to run each step. Those steps run functions that are
defined in the <code>commons</code> module of Cloud Pipelines.</p>
</div>
<div class="paragraph">
<p>Cloud Pipelines performs steps to guess what kind of a project your
repository is (for example, JVM or PHP) and what framework it uses (Maven or Gradle), and it
can deploy your application to a cloud (Cloud Foundry or Kubernetes). You can read about how
it works by reading the <a href="#how-do-the-scripts-work">[how-do-the-scripts-work]</a> section.</p>
</div>
<div class="paragraph">
<p>All of that happens automatically if your application follows the conventions.
You can read about them in the <a href="#project-opinions">[project-opinions]</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="centralized-pipeline-creation">1.2.3. Centralized Pipeline Creation</h4>
<div class="paragraph">
<p>You can use Cloud Pipelines to generate pipelines
for all the projects in your system. You can scan all your
repositories (for example, you can call the Stash or Github API to retrieve the list of repositories)
and then call <code>fly</code> and set the pipeline for every repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We recommend using Cloud Pipelines this way.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="a-pipeline-for-each-repository">1.2.4. A Pipeline for Each Repository</h4>
<div class="paragraph">
<p>You can use Cloud Pipelines in such a way that
ach project contains its own pipeline steps,
and it is up to the project to set up the pipeline.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-flow">1.3. The Flow</h3>
<div class="paragraph">
<p>The following images show the flow of the opinionated pipeline:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/flow_concourse.png" alt="flow concourse">
</div>
<div class="title">Figure 2. Flow in Concourse</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/flow.png" alt="flow">
</div>
<div class="title">Figure 3. Flow in Jenkins</div>
</div>
<div class="paragraph">
<p>We first describe the overall concept behind the flow and then
split it into pieces and describe each piece independently.</p>
</div>
</div>
<div class="sect2">
<h3 id="vocabulary">1.4. Vocabulary</h3>
<div class="paragraph">
<p>This section defines some common vocabulary. We describe four typical
environments in terms of running the pipeline.</p>
</div>
<div class="sect3">
<h4 id="environments">1.4.1. Environments</h4>
<div class="paragraph">
<p>We typically encounter the following environments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>build</strong> environment is a machine where the building of the application takes place.
It is a continuous integration or continuous delivery tool worker.</p>
</li>
<li>
<p><strong>test</strong> is an environment where you can deploy an application to test it. It does not
resemble production, because we cannot be sure of its state (which application is deployed
there and in which version). It can be used by multiple teams at the same time.</p>
</li>
<li>
<p><strong>stage</strong> is an environment that does resemble production. Most likely, applications
are deployed there in versions that correspond to those deployed to production.
Typically, staging databases hold (often obfuscated) production data. Most
often, this environment is a single environment shared between many teams. In other
words, in order to run some performance and user acceptance tests, you have to block
and wait until the environment is free.</p>
</li>
<li>
<p><strong>prod</strong> is the production environment where we want our tested applications to be
deployed for our customers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="tests">1.4.2. Tests</h4>
<div class="paragraph">
<p>We typically encounter the following kinds of tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unit tests</strong>: Tests that run on the application during the build phase.
No integrations with databases or HTTP server stubs or other resources take place.
Generally speaking, your application should have plenty of these tests to provide fast
feedback about whether your features work.</p>
</li>
<li>
<p><strong>Integration tests</strong>: Tests that run on the built application during the build phase.
Integrations with in-memory databases and HTTP server stubs take place. According to the
<a href="https://martinfowler.com/bliki/TestPyramid.html">test pyramid</a>, in most cases, you should
not have many of these kind of tests.</p>
</li>
<li>
<p><strong>Smoke tests</strong>: Tests that run on a deployed application. The concept of these tests
is to check that the crucial parts of your application are working properly. If you have 100 features
in your application but you gain the most money from five features, you could write smoke tests
for those five features. We are talking about smoke tests of an application, not of
the whole system. In our understanding inside the opinionated pipeline, these tests are
executed against an application that is surrounded with stubs.</p>
</li>
<li>
<p><strong>End-to-end tests</strong>: Tests that run on a system composed of multiple applications.
These tests ensure that the tested feature works when the whole system is set up.
Due to the fact that it takes a lot of time, effort, and resources to maintain such an environment
and that these tests are often unreliable (due to many different moving pieces, such as network,
database, and others), you should have a handful of those tests. They should be only for critical parts of your business.
Since only production is the key verifier of whether your feature works, some companies
do not even want to have these tests and move directly to deployment to production. When your
system contains KPI monitoring and alerting, you can quickly react when your deployed application
does not behave properly.</p>
</li>
<li>
<p><strong>Performance testing</strong>: Tests run on an application or set of applications
to check if your system can handle a big load. In the case of our opinionated pipeline,
these tests can run either on test (against a stubbed environment) or on
staging (against the whole system).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="testing-against-stubs">1.4.3. Testing against Stubs</h4>
<div class="paragraph">
<p>Before we go into the details of the flow, consider the example described by the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/monolith.png" alt="monolith">
</div>
<div class="title">Figure 4. Two monolithic applications deployed for end to end testing</div>
</div>
<div class="paragraph">
<p>When you have only a handful of applications, end-to-end testing is beneficial.
From the operations perspective, it is maintainable for a finite number of deployed instances.
From the developers perspective, it is nice to verify the whole flow in the system
for a feature.</p>
</div>
<div class="paragraph">
<p>In the case of microservices, the scale starts to be a problem, as the following image shows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/many_microservices.png" alt="many microservices">
</div>
<div class="title">Figure 5. Many microservices deployed in different versions</div>
</div>
<div class="paragraph">
<p>The following questions arise:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Should I queue deployments of microservices on one testing environment or should I have an environment per microservice?</p>
<div class="ulist">
<ul>
<li>
<p>If I queue deployments, people have to wait for hours to have their tests run. That can be a problem</p>
</li>
</ul>
</div>
</li>
<li>
<p>To remove that issue, I can have an environment for each microservice.</p>
<div class="ulist">
<ul>
<li>
<p>Who will pay the bills? (Imagine 100 microservices, each having each own environment).</p>
</li>
<li>
<p>Who will support each of those environments?</p>
</li>
<li>
<p>Should we spawn a new environment each time we execute a new pipeline and then wrap it up or should we have
them up and running for the whole day?</p>
</li>
</ul>
</div>
</li>
<li>
<p>In which versions should I deploy the dependent microservices - development or production versions?</p>
<div class="ulist">
<ul>
<li>
<p>If I have development versions, I can test my application against a feature that is not yet on production.
That can lead to exceptions in production.</p>
</li>
<li>
<p>If I test against production versions, I can never test against a feature under development
anytime before deployment to production.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of the possibilities of tackling these problems is to not do end-to-end tests.</p>
</div>
<div class="paragraph">
<p>The following image shows one solution to the problem, in the form of stubbed dependencies:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/stubbed_dependencies.png" alt="stubbed dependencies">
</div>
<div class="title">Figure 6. Execute tests on a deployed microservice on stubbed dependencies</div>
</div>
<div class="paragraph">
<p>If we stub out all the dependencies of our application, most of the problems presented earlier
disappear. There is no need to start and setup the infrastructure required by the dependent
microservices. That way, the testing setup looks like the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/scripts/master/docs/images/intro/stubbed_dependencies.png" alt="stubbed dependencies">
</div>
<div class="title">Figure 7. We&#8217;re testing microservices in isolation</div>
</div>
<div class="paragraph">
<p>Such an approach to testing and deployment gives the following benefits
(thanks to the usage of <a href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html">Spring Cloud Contract</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No need to deploy dependent services.</p>
</li>
<li>
<p>The stubs used for the tests run on a deployed microservice are the same as those used during integration tests.</p>
</li>
<li>
<p>Those stubs have been tested against the application that produces them (see <a href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html">Spring Cloud Contract</a> for more information).</p>
</li>
<li>
<p>We do not have many slow tests running on a deployed application, so the pipeline gets executed much faster.</p>
</li>
<li>
<p>We do not have to queue deployments. We test in isolation so that pipelines do not interfere with each other.</p>
</li>
<li>
<p>We do not have to spawn virtual machines each time for deployment purposes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, this approach brings the following challenges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No end-to-end tests before production. You do not have full certainty that a feature is working.</p>
</li>
<li>
<p>The first time the applications interact in a real way is on production.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As with every solution, it has its benefits and drawbacks. The opinionated pipeline
lets you configure whether you want to follow this flow or not.</p>
</div>
</div>
<div class="sect3">
<h4 id="general-view">1.4.4. General View</h4>
<div class="paragraph">
<p>The general view behind this deployment pipeline is to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test the application in isolation.</p>
</li>
<li>
<p>Test the backwards compatibility of the application, in order to roll it back if necessary.</p>
</li>
<li>
<p>Allow testing of the packaged application in a deployed environment.</p>
</li>
<li>
<p>Allow user acceptance tests and performance tests in a deployed environment.</p>
</li>
<li>
<p>Allow deployment to production.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pipeline could have been split to more steps, but it seems that all of the aforementioned
actions fit nicely in our opinionated proposal.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="customizing-the-project">2. Customizing the Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cloud Pipelines offers a number of ways to customize a Pipelines project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#customization-overriding-scripts">Overriding Scripts</a></p>
</li>
<li>
<p><a href="#customization-overriding-pipelines">Overriding Pipelines</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="customization-overriding-scripts">2.1. Overriding Scripts</h3>
<div class="paragraph">
<p>You can read the documentation of <a href="https://github.com/CloudPipelines/scripts">Cloud Pipelines Scripts</a>
to see how to override the scripts.</p>
</div>
</div>
<div class="sect2">
<h3 id="customization-overriding-pipelines">2.2. Overriding Pipelines</h3>
<div class="paragraph">
<p>Currently, the best way to extend the Concourse is to make
a copy of the Concourse pipeline <code>yaml</code> files and modify it.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-by-step-cloud-foundry-migration">3. Step-by-step Cloud Foundry Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section details how to migrate applications such that they become compatible with  Cloud Pipelines.</p>
</div>
<div class="sect2">
<h3 id="preview">3.1. Preview</h3>
<div class="paragraph">
<p><a href="https://docs.google.com/presentation/d/e/2PACX-1vSsEHn8cJfz8oWIwwUhdULt7nZzz3bBLK7OqM8UInkZ0LbQBCpPdhMoxsYGPe_90h9OvCu7dFlAimMJ/pub?start=false&amp;loop=false&amp;delayms=3000">Click here</a> to
check out the slides by <a href="https://twitter.com/ciberkleid">Cora Iberkleid</a> where she
migrates a set of applications to be compliant with Cloud Pipelines.</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-2">3.2. Introduction</h3>
<div class="paragraph">
<p>This tutorial covers refactoring applications to be compatible with, and take advantage of, Cloud Pipelines.</p>
</div>
<div class="paragraph">
<p>As an example, we use a simple three-tier application, shown in the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/use_case_logical.png" alt="use case logical">
</div>
<div class="title">Figure 8. Use Case - Logical View</div>
</div>
<div class="paragraph">
<p>At the end of this tutorial, you will be able to quickly create a Concourse pipeline for each application and run successfully through a full lifecycle, from source code commit to production deployment, following the lifecycle stages for testing and deployment recommended by Cloud Pipelines. You will be able to improve application code bases with organized test coverage, a contract-based API, and a versioned database schema, letting Cloud Pipelines carry out stubbed testing and ensure backward compatibility for API and database schema changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="sample-application-initial-state">3.3. Sample Application&#8201;&#8212;&#8201;Initial State</h3>
<div class="paragraph">
<p>The sample application is implemented by using Spring Boot applications for the UI and service tiers and MySQL for the database.</p>
</div>
<div class="paragraph">
<p>The apps are built with Maven and manually pushed to Cloud Foundry. They leverage the three Pivotal Spring Cloud Services: Config Server, Service Discovery, and Circuit Breaker Dashboard. We use Rabbit to propagate Config Server refresh triggers.</p>
</div>
<div class="paragraph">
<p>The source code for the two Spring Boot applications is stored on GitHub, as is the backing repo for Config Server.</p>
</div>
<div class="paragraph">
<p>The following image shows an implementation view of the applications and their ancillary services:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/use_case_implementation.png" alt="use case implementation">
</div>
<div class="title">Figure 9. Use Case - Implementation</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-application-end-state">3.4. Sample Application&#8201;&#8212;&#8201;End State</h3>
<div class="paragraph">
<p>Throughout this tutorial, we add Concourse and JFrog Bintray to manage the application lifecycle.</p>
</div>
<div class="paragraph">
<p>We also refactor the applications so that they become compatible with Cloud Pipelines requirements and recommendations, including adding and organizing tests and introducing database versioning by using Flyway and introducing API contracts by using Spring Cloud Contract.</p>
</div>
</div>
<div class="sect2">
<h3 id="tutorial-toolset">3.5. Tutorial&#8201;&#8212;&#8201;Toolset</h3>
<div class="paragraph">
<p>Throughout this tutorial, we use the following tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GitHub</strong>: Sample application source code and configuration repositories, a sample stubrunner application repository, and the Cloud Pipelines code base, including the following:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ciberkleid/greeting-ui"><code>greeting-ui</code></a></p>
</li>
<li>
<p><a href="https://github.com/ciberkleid/fortune-service"><code>fortune-service</code></a></p>
</li>
<li>
<p><a href="https://github.com/ciberkleid/app-config">`app-confi`g</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot"><code>cloudfoundry-stub-runner-boot</code></a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud/spring-cloud-pipelines"><code>spring-cloud-pipelines</code></a></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Pivotal Web Services</strong>: Publicly hosted Cloud Foundry offering <a href="http://run.pivotal.io">free trial accounts</a> and including MySQL, Rabbit, and Pivotal Spring Cloud Services in the Marketplace</p>
</li>
<li>
<p><strong>Concourse</strong></p>
</li>
<li>
<p><strong>JFrog Bintray</strong>: Publicly hosted Maven repository offering free <a href="https://bintray.com/signup/oss">OSS accounts</a></p>
</li>
<li>
<p><strong>Client Tools</strong>: On your local machine, you need an IDE as well as the mvn, git, cf, and fly (Concourse) CLIs</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="tutorial-overview">3.6. Tutorial&#8201;&#8212;&#8201;Overview</h3>
<div class="paragraph">
<p>We separate the migration steps into three stages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Scaffolding</strong></p>
<div class="ulist">
<ul>
<li>
<p>Minimal refactoring to be compatible with basic Cloud Pipelines requirements.</p>
</li>
<li>
<p>At the end of this stage, each application has a corresponding pipeline on Concourse. The pipelines successfully build the applications, store the artifacts in Bintray, tag the GitHub repositories, and deploy the applications to the Test, Stage, and Prod spaces in Cloud Foundry.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tests</strong></p>
<div class="ulist">
<ul>
<li>
<p>Add and organize tests to be compatible with Cloud Pipelines recommendations.</p>
</li>
<li>
<p>Incorporate flyway for database schema versioning and initial data loading.</p>
</li>
<li>
<p>At the end of this stage, the pipelines trigger unit and integration tests during the Build stage, smoke tests in the Test environment, and end-to-end tests in the Stage environment. The pipelines also ensure backward compatibility for the database, such that you can safely roll back the backend service application, even after the database schema has been updated.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Contracts</strong></p>
<div class="ulist">
<ul>
<li>
<p>Incorporate Spring Cloud Contract to define the API between the UI and service apps and auto-generate tests and stubs.</p>
</li>
<li>
<p>At the end of this stage, the pipelines catch breaking API changes during the Build stage and ensure backward compatibility for the API, such that you can safely roll back the backend service (producer) app, even after an API change.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="tutorial-step-by-step">3.7. Tutorial&#8201;&#8212;&#8201;Step-by-step</h3>
<div class="paragraph">
<p>The remainder of this chapter is the actual tutorial, which consists of a preparation stage and three main stages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#tutorial-prep">Prep: Before you begin</a></p>
</li>
<li>
<p><a href="#tutorial-stage-one">Stage One: Scaffolding</a></p>
</li>
<li>
<p><a href="#tutorial-stage-two">Stage Two: Tests</a></p>
</li>
<li>
<p><a href="#tutorial-stage-three">Stage Three: Contracts</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="tutorial-prep">3.7.1. Prep: Before you begin</h4>
<div class="paragraph">
<p>If you want to simply review the migration steps explained below, you can look at the various branches in the <a href="https://github.com/ciberkleid/greeting-ui">greeting-ui</a> and <a href="https://github.com/ciberkleid/fortune-service">fortune-service</a> repositories. A branch represents the end-state of each stage, as the following image shows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/github_branches.png" alt="github branches">
</div>
<div class="title">Figure 10. GitHub Branches</div>
</div>
<div class="paragraph">
<p>If you want to use this tutorial as a hands-on lab, fork each of the following repositories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ciberkleid/greeting-ui">greeting-ui</a></p>
</li>
<li>
<p><a href="https://github.com/ciberkleid/fortune-service">fortune-service</a></p>
</li>
<li>
<p><a href="https://github.com/ciberkleid/app-config">app-config</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then create a new directory on your local machine. You may name it anything you like. We refer to it as <code>$SCP_HOME</code> throughout this tutorial.</p>
</div>
<div class="paragraph">
<p>In <code>$SCP_HOME</code>, clone your forks of <code>greeting-ui</code> and <code>fortune-service</code>, as well as the following two repositories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot">cloudfoundry-stub-runner-boot</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud/spring-cloud-pipelines">spring-cloud-pipelines</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, create a directory called <code>$SCP_HOME/credentials</code>. Leave it empty for now.</p>
</div>
</div>
<div class="sect3">
<h4 id="tutorial-stage-one">3.7.2. Stage One: Scaffolding</h4>
<div class="paragraph">
<p>In this stage, we make minimal changes to satisfy basic Cloud Pipelines requirements so that the applications can run through the entire pipeline without error. We make &#8220;scaffolding&#8221; changes only&#8201;&#8212;&#8201;no code changes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must complete the steps in this stage for both <code>greeting-ui</code> and <code>fortune-service</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="1-1-create-github-branches">1.1 Create GitHub Branches</h5>
<div class="paragraph">
<p>Create branches in GitHub by using the following git commands:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git branch version
git checkout -b sc-pipelines</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>version</code> branch is required to exist, though it can be created as an empty branch. It is used by Spring Coud Pipelines to generate a version number for each new pipeline execution.</p>
</div>
<div class="paragraph">
<p>The <code>sc-pipelines</code> branch is optional and can be named anything you wish. The intention is for you to use it as a working branch for the changes suggested in this tutorial (hence, you should both create it and check it out).</p>
</div>
</div>
<div class="sect4">
<h5 id="1-2-add-maven-wrapper">1.2 Add Maven Wrapper</h5>
<div class="paragraph">
<p>This step covers how to add the Maven wrapper (which lets your users build without having Maven on the path). To add the Maven wrapper, run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">mvn -N io.takari:maven:wrapper</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This commands adds four files to a project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>.
 mvnw
 mvnw.cmd
 .mvn
     wrapper
       maven-wrapper.jar
       maven-wrapper.properties</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Make sure all four files are tracked by Git. One way to do so is to add the following lines to the <code>.gitignore</code> file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>#Exceptions
!/mvnw
!/mvnw.cmd
!/.mvn/wrapper/maven-wrapper.jar
!/.mvn/wrapper/maven-wrapper.properties</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="1-3-create-the-bintray-maven-repository-package">1.3 Create the Bintray Maven Repository Package</h5>
<div class="paragraph">
<p>We use Bintray as the Maven repository. Bintray requires that a package exist before any application artifacts can be uploaded.</p>
</div>
<div class="paragraph">
<p>Log into the Bintray UI and create the packages as follows (you can use the &#8220;Import from GitHub&#8221; option to create these):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/bintray_packages.png" alt="bintray packages">
</div>
<div class="title">Figure 11. Bintray Packages</div>
</div>
</div>
<div class="sect4">
<h5 id="1-4-configure-distribution-management-by-using-the-bintray-maven-repository">1.4 Configure Distribution Management by Using the Bintray Maven Repository</h5>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must do this step for both application repositories.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the application <code>pom.xml</code> files. Make sure that the Bintray URLs match the URLs of the corresponding packages created in the previous step. The values you use should differ from the following example in that they should point to your repository:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;properties&gt;
...
&lt;distribution.management.release.id&gt;bintray&lt;/distribution.management.release.id&gt;
&lt;distribution.management.release.url&gt;https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service&lt;/distribution.management.release.url&gt;
&lt;/properties&gt;

...

&lt;distributionManagement&gt;
&lt;repository&gt;
&lt;id&gt;${distribution.management.release.id}&lt;/id&gt;
&lt;url&gt;${distribution.management.release.url}&lt;/url&gt;
&lt;/repository&gt;
&lt;/distributionManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Though not required by Cloud Pipelines, it makes sense to also configure your local maven settings with the credentials to your Bintray maven repository. To do so, edit your maven settings file (usually <code>~/.m2/settings.xml</code>). If the file does not exist, create it.</p>
</div>
<div class="paragraph">
<p>Note that the <code>id</code> must match the <code>id</code> specified in the previous step. Also, make sure to use your username and API token (not your account password) instead of the sample values shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;settings&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;bintray&lt;/id&gt;
      &lt;username&gt;ciberkleid&lt;/username&gt;
      &lt;password&gt;my-super-secret-api-token&lt;/password&gt;
   &lt;/server&gt;
 &lt;/servers&gt;
&lt;/settings&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="1-5-push-changes-to-github">1.5 Push Changes to GitHub</h5>
<div class="paragraph">
<p>Push the changes you made in the preceding step to GitHub. You should be pushing the following to each of the two application repositories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Four new Maven wrapper files</p>
</li>
<li>
<p>A modified <code>.gitignore</code> file</p>
</li>
<li>
<p>A modified <code>pom.xml</code> file</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="1-6-add-a-cloud-pipelines-credentials-file">1.6 Add a Cloud Pipelines Credentials File</h5>
<div class="paragraph">
<p>In <code>$SCP_HOME/credentials</code>, make two copies of the <code>$SCP_HOME/spring-cloud-pipelines/concourse/credentials-sample-cf.yml</code> file. Rename them as <code>credentials-fortune-service.yml</code> and <code>credentials-greeting-ui.yml</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
These files will contain credentials to your GitHub repository, your Bintray repository, and your Cloud Foundry foundation. Hence, we opt to put them in a separate directory. You may choose to store these files in a private Git repository, but do not push them to a public repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the Git properties of each credentials file. Make sure to replace the sample values shown in our example. For <code>concourse-scripts-branch</code>, you can use a fixed release (use v1.0.0.M8 or later for Cloud Foundry). Leave the other values as they are. We update those in later steps. The following listing shows a credentials file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">app-url: git@github.com:ciberkleid/fortune-service.git
app-branch: sc-pipelines
concourse-scripts-url: https://github.com/CloudPipelines/scripts.git
concourse-scripts-branch: master
build-options: ""

github-private-key: |
  -----BEGIN RSA PRIVATE KEY-----
  MIIJKQIBAAKCAgEAvwkL97vBllOSE39Wa5ppczT1cr5Blmkhadfoa1Va2/IBVyvk
  NJ9PqoTI+BahF2EgzweyiDSvKsstlTsG7QgiM9So8Voi2PlDOrXL6uOfCuAS/G8X
  ...
  -----END RSA PRIVATE KEY-----
git-email: ciberkleid@pivotal.io
git-name: Cora Iberkleid</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Edit the Maven repository properties of each credentials file. Make sure to replace the sample values shown in our example. Bintray requires separate URLs for uploads and downloads. If you use a different artifact repository, such as Artifactory or Nexus, and the repository URL is the same for uploads and downloads, you do not need to set <code>repo-with-binaries-for-upload</code>. The following listing shows the values to add or edit in your credentials file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">m2-settings-repo-id: bintray
m2-settings-repo-username: ciberkleid
m2-settings-repo-password: my-super-secret-api-token

repo-with-binaries: https://ciberkleid:my-super-secret-api-token@dl.bintray.com/ciberkleid/maven-repo

repo-with-binaries-for-upload: https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="1-7-set-the-concourse-pipeline">1.7 Set the Concourse Pipeline</h5>
<div class="paragraph">
<p>At this point, all of the build jobs, which run on Concourse workers, should succeed.</p>
</div>
<div class="paragraph">
<p>To verify this, log in to your Concourse target and set the Concourse pipelines. Update the target name in the following example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"># Set greeting-ui pipeline
fly -t myTarget set-pipeline -p greeting-ui -c "${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml" -l "${SCP_HOME}/credentials/credentials-greeting-ui.yml" -n

# Set fortune-service pipeline
fly -t myTarget set-pipeline -p fortune-service -c "${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml" -l "${SCP_HOME}/credentials/credentials-fortune-service.yml" -n</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Log into the Concourse UI and un-pause the pipelines. Start each pipeline. You should see that the build jobs all succeed, similar to the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/concourse_build_success.png" alt="concourse build success">
</div>
<div class="title">Figure 12. Build Success</div>
</div>
<div class="paragraph">
<p>In addition, you should see a new <code>dev/&lt;version_number&gt;</code> tag in each GitHub repository and see the app jars uploaded into Bintray.</p>
</div>
<div class="paragraph">
<p>The test, stage, and prod jobs fail, because we have not yet added scaffolding for deployment to Cloud Foundry. We do that next.</p>
</div>
</div>
<div class="sect4">
<h5 id="1-8-add-cloud-foundry-manifest">1.8 Add Cloud Foundry manifest</h5>
<div class="paragraph">
<p>If you are deploying to Cloud Foundry, you may already be routinely including manifest files with your applications. Our sample applications did not have manifest files, so we add them now.</p>
</div>
<div class="paragraph">
<p>In the <code>greeting-ui</code> repository, create a <code>manifest.yml</code> file as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: greeting-ui
  timeout: 120
  services:
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the <code>fortune-service</code> repository, create a <code>manifest.yml</code> file as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>TRUST_CERTS</code> variable is used by the Pivotal Spring Cloud Services (Config Server, Service Registry, and Circuit Breaker Dashboard), which we use in this example. The value specified in the preceding example assumes deployment to Pivotal Web Services. Update it accordingly if you are deploying to a different Cloud Foundry foundation, or you can leave it out altogether if you are replacing the Pivotal Spring Cloud Services with alternative implementations (for example, deploying the services as applications and exposing them as user-provided services).</p>
</div>
<div class="paragraph">
<p>If you wishi, you can add additional values to the manifest files&#8201;&#8212;&#8201;for example, if additional values are useful for any manual deployment you may still want to do or if you need additional values in your Cloud Pipelines deployment. For example, the following file could be an alternative <code>manifest.yml</code> for <code>fortune-service</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: fortune-service
  timeout: 120
  instances: 3
  memory: 1024M
  buildpack: https://github.com/cloudfoundry/java-buildpack.git
  random-route: true
  path: ./target/fortune-service-0.0.1-SNAPSHOT.jar
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: someProfile
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that Cloud Pipelines ignores <code>random-route</code> and <code>path</code>. <code>instances</code> is honored in stage and prod but is overridden with a value of 1 for test.</p>
</div>
</div>
<div class="sect4">
<h5 id="1-9-add-the-cloud-pipelines-manifest">1.9 Add the Cloud Pipelines Manifest</h5>
<div class="paragraph">
<p>The Cloud Foundry manifest created in the previous step includes the logical names of the services to which the applications should be bound, but it does not describe how the services can be provisioned. Hence, we add a second manifest file so that Cloud Pipelines can provision the services.</p>
</div>
<div class="paragraph">
<p>Add a file called <code>sc-pipelines.yml</code> to each application and include the same list of services as in the corresponding <code>manifest.yml</code>. Add the necessary details such that Cloud Pipelines can construct a <code>cf create-service</code> command.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The `type: broker' parameter in the next example instructs Cloud Pipelines to provision a service by using `cf create-service'. Other service types are also supported: cups, syslog, route, app, and stubrunner.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More specifically, for <code>greeting-ui</code>, create an <code>sc-pipelines.yml</code> file with the following content:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">test:
  services:
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>sc-pipelines.yml</code> file for <code>fortune-service</code> is similar, with the addition of the <code>fortune-db</code> service, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">test:
  # list of required services
  services:
    - name: fortune-db
      type: broker
      broker: cleardb
      plan: spark
      useExisting: true
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The values in the preceding two examples assume deployment to Pivotal Web Services. If you are deploying to a different Cloud Foundry foundation, update the values accordingly. Also, make sure to replace the <code>config-server</code> URI with the address of your fork of the <a href="https://github.com/ciberkleid/app-config"><code>app-config</code></a> repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Notice the <code>useExisting: true</code> parameter in the preceding example. By default, Cloud Pipelines deletes and re-creates services in the <code>test</code> space. To override this behavior and re-use existing services, we set <code>useExisting: true</code>. This is helpful in cases where services  may take time to provision and initialize, where there is no risk in re-using them between pipeline runs, or where it is desirable to retain the service instance from the last pipeline run (for example, a database migration).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="1-10-push-changes-to-github">1.10 Push changes to GitHub</h5>
<div class="paragraph">
<p>Push the preceding changes to GitHub. You should be pushing the following to each of the two application repositories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new app manifest file</p>
</li>
<li>
<p>A new sc-pipelines manifest file</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="1-11-create-cloud-foundry-orgs-and-spaces">1.11 Create Cloud Foundry Orgs and Spaces</h5>
<div class="paragraph">
<p>Cloud Pipelines requires that the Cloud Foundry test, stage, and prod spaces exist before a pipeline is run. If you wish, you can use different foundations, orgs, and users for each. For simplicity, in this example, we use a single foundation (PWS), a single org, and a single user.</p>
</div>
<div class="paragraph">
<p>You can name the orgs and spaces anything you like. Each app requires its own test space. The stage and prod spaces are shared.</p>
</div>
<div class="paragraph">
<p>For this example, use the following commands to create spaces:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf create-space scp-test-greeting-ui
cf create-space scp-test-fortune-service
cf create-space scp-stage
cf create-space scp-prod</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="1-12-create-cloud-foundry-stage-and-prod-service-instances">1.12 Create Cloud Foundry Stage and Prod Service Instances</h5>
<div class="paragraph">
<p>Cloud Pipelines dynamically creates the services in the test spaces, as defined by the <code>sc-pipelines.yml</code> file we created previously. Optionally, you can add a second section to the <code>sc-pipelines.yml</code> file for the stage environment, and these are created dynamically as well. However, you must always crate prod manually.</p>
</div>
<div class="paragraph">
<p>For this example, we create both the stage and prod services manually.</p>
</div>
<div class="paragraph">
<p>Create the services listed in the application manifest files in both <code>scp-stage</code> and <code>scp-prod</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="1-13-update-the-cloud-pipelines-credentials-file">1.13 Update the Cloud Pipelines Credentials File</h5>
<div class="paragraph">
<p>Update the <code>greeting-ui</code> and <code>fortune-service</code> credentials files with Cloud Foundry information. Replace values in the next example as appropriate for your Cloud Foundry environment.</p>
</div>
<div class="paragraph">
<p>Notice that the test space name specified is a prefix, unlike the stage and prod space names, which are literals. Cloud Pipelines append the application name to the test space name, thereby matching the test space names we created manually. The stage and prod space names are not prefixes and are not altered by Cloud Pipelines.</p>
</div>
<div class="paragraph">
<p>Note also the <code>paas-hostname-uuid</code>. The value is included in each created route. This value is optional, but it is useful in shared or multi-tenant environments (such as PWS), as it helps to ensure routes are unique. Change it to a unique uuid.</p>
</div>
<div class="paragraph">
<p>The following example shows an updated credentials file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">pipeline-descriptor: sc-pipelines.yml

paas-type: cf

paas-hostname-uuid: cyi

# test values
paas-test-api-url: https://api.run.pivotal.io
paas-test-username: ciberkleid@pivotal.io
paas-test-password: secret
paas-test-org: S1Pdemo12
paas-test-space-prefix: scp-test

# stage values
paas-stage-api-url: https://api.run.pivotal.io
paas-stage-username: ciberkleid@pivotal.io
paas-stage-password: my-super-secret-password
paas-stage-org: S1Pdemo12
paas-stage-space: scp-stage

# prod values
paas-prod-api-url: https://api.run.pivotal.io
paas-prod-username: ciberkleid@pivotal.io
paas-prod-password: my-super-secret-password
paas-prod-org: S1Pdemo12
paas-prod-space: scp-prod</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="1-14-update-the-concourse-pipeline-with-updated-credentials-files">1.14 Update the Concourse Pipeline with Updated Credentials Files</h5>
<div class="paragraph">
<p>Set the Concourse pipelines again, as we did previously, to update them with the values added to the credentials files. The test, stage, and prod jobs should all now succeed and result in output similar to the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/concourse_test_stage_prod_success.png" alt="concourse test stage prod success">
</div>
<div class="title">Figure 13. Test, Stage, &amp; Prod Success</div>
</div>
<div class="paragraph">
<p>On Cloud Foundry, you should now see the apps deployed in the test, stage, and prod spaces. The following image shows the deployment of <code>fortune-service</code> to its dedicated test space:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/cf_test_and_prod_deployed.png" alt="cf test and prod deployed">
</div>
<div class="title">Figure 14. Cloud Foundry Test and Prod Deployment</div>
</div>
<div class="paragraph">
<p>Notice that the five services declared in its manifest files (<code>sc-pipelines.yml</code> for provisioning and <code>manifest.yml</code> for binding) have also been automatically provisioned. The image also shows the deployment of the same app to the shared prod space. Notice that the instance of the previous version has been renamed as <code>venerable</code> and stopped. If a rollback were deemed necessary, the <code>prod-rollback</code> job in the pipeline could be triggered to remove the currently running version, remove the <code>prod/&lt;version_number&gt;</code> tag from GitHub, and re-start the former (<code>venerable</code>) version.</p>
</div>
</div>
<div class="sect4">
<h5 id="stage-one-recap-and-next-steps">Stage One Recap and Next Steps</h5>
<div class="paragraph">
<p>What have we accomplished?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By adding the basic scaffolding needed to enable Cloud Pipelines to manage the lifecycle of <code>greeting-ui</code> and <code>fortune-service</code> from source code commit to production deploy, we have made it possible for the application development teams to instantly and easily create pipelines for each application by using a common, standardized template.</p>
</li>
<li>
<p>We can count on the pipelines to:</p>
<div class="ulist">
<ul>
<li>
<p>Automatically provision services in test spaces and, optionally, in stage spaces as well.</p>
</li>
<li>
<p>Dynamically clean up the test spaces between pipeline executions.</p>
</li>
<li>
<p>Upload the app artifacts to the maven repo (for example, Bintray).</p>
</li>
<li>
<p>Tag the git repositories with <code>dev/&lt;version_number&gt;</code> and <code>prod/&lt;version_number&gt;</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>After each successful pipeline run, we can, if necessary, to roll back to the last deployed version byusing the <code>prod-rollback</code> job.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These accomplishments are extremely valuable. However, to derive confidence and reliability from the pipelines, we need to incorporate testing. We do this in Stage Two of the application migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tutorial-stage-two">3.7.3. Stage Two: Tests</h4>
<div class="paragraph">
<p>In this stage, we enable Cloud Pipelines to execute tests so that we can increase confidence in the code being deployed. We do so by adding test profiles to the <code>pom.xml</code> files and then organizing or adding tests in a way that corresponds to the profiles. By doing so, we establish standards around testing across development teams in the enterprise.</p>
</div>
<div class="paragraph">
<p>We will also enable database schema versioning in this stage, thereby providing the foundation for rollback testing during schema changes.</p>
</div>
<div class="sect4">
<h5 id="2-1-add-maven-profiles">2.1 Add Maven Profiles</h5>
<div class="paragraph">
<p>For both <code>greeting-ui</code> and <code>fortune-service</code>, add a <code>profiles</code> section to the <code>pom.xml</code> file, as shown in the next listing. Note that we are adding four profiles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default</code></p>
<div class="ulist">
<ul>
<li>
<p>For unit and integration tests. Note that this profile includes all tests except those that are explicitly called by the smoke and e2e profiles.</p>
</li>
<li>
<p>Tests matching this profile run during the build-and-upload job.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>apicompatibility</code></p>
<div class="ulist">
<ul>
<li>
<p>For ensuring backward compatibility in case of API changes. Note that this is not effective until Stage Three, when we will add contracts. However, we add this profile now to ensure the api compatibility check during the <code>build-and-upload</code> job does not run other tests.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>smoke</code></p>
<div class="ulist">
<ul>
<li>
<p>For tests to be run against the application deployed in the test space.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>e2e</code></p>
<div class="ulist">
<ul>
<li>
<p>For tests to be run against the application deployed in the stage space.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following listing shows the necessary <code>profiles</code> element of a <code>pom.xml</code> file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;default&lt;/id&gt;
      &lt;activation&gt;
        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
      &lt;/activation&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;**/*Tests.java&lt;/include&gt;
                &lt;include&gt;**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
              &lt;excludes&gt;
                &lt;exclude&gt;**/smoke/**&lt;/exclude&gt;
                &lt;exclude&gt;**/e2e/**&lt;/exclude&gt;
              &lt;/excludes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
      &lt;id&gt;apicompatibility&lt;/id&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;**/contracttests/**/*Tests.java&lt;/include&gt;
                &lt;include&gt;**/contracttests/**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
      &lt;id&gt;smoke&lt;/id&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;smoke/**/*Tests.java&lt;/include&gt;
                &lt;include&gt;smoke/**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
      &lt;id&gt;e2e&lt;/id&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;e2e/**/*Tests.java&lt;/include&gt;
                &lt;include&gt;e2e/**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="2-2-add-and-organize-tests">2.2 Add and Organize Tests</h5>
<div class="paragraph">
<p>Next, we ensure that we have a matching test package structure in our apps, as the following image shows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/test_package_structure.png" alt="test package structure">
</div>
<div class="title">Figure 15. Test Package Structure</div>
</div>
<div class="paragraph">
<p>Note that we are creating matching packages only for the default, smoke, and e2e profiles. We will address the package for the <code>apicompatibility</code> profile in Stage Three.</p>
</div>
<div class="paragraph">
<p>When working with your own applications, if you have existing tests, you would move the files into one of these packages now and rename them so that they are included by the filters declared in the profiles (that is, the file names end in <code>Test.java</code> or <code>Tests.java</code>)</p>
</div>
<div class="paragraph">
<p>In the case of our sample apps, we have no tests, so we add some now.</p>
</div>
<div class="sect5">
<h6 id="code-fortune-service-code-default-tests"><code>fortune-service</code> Default Tests</h6>
<div class="paragraph">
<p>Add your unit and integration tests so that they match the default profile, as defined in the <code>fortune-service</code> <code>pom.xml</code> file. These are run on Concourse against the <code>fortune-service</code> application that runs on the Concourse worker in the <code>build-and-upload</code> job.</p>
</div>
<div class="paragraph">
<p>As an example, we add two tests, one that loads the context and another that verifies the number of rows expected in the database. The following example defines these tests:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package io.pivotal;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import org.springframework.jdbc.core.JdbcTemplate;
import static org.assertj.core.api.Assertions.assertThat;

import static org.junit.Assert.*;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = FortuneServiceApplication.class)
public class FortuneServiceApplicationTests {

    @Test
    public void contextLoads() throws Exception {

    }

    @Autowired
    private JdbcTemplate template;

    @Test
    public void testDefaultSettings() throws Exception {
        assertThat(this.template.queryForObject("SELECT COUNT(*) from FORTUNE",
                Integer.class)).isEqualTo(7);
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="code-fortune-service-code-smoke-tests"><code>fortune-service</code> Smoke Tests</h6>
<div class="paragraph">
<p>Add your smoke tests so that they match the smoke profile, as defined in the <code>fortune-service</code> <code>pom.xml</code> file. These run on Concourse against the <code>fortune-service</code> application deployed in the Cloud Foundry <code>scp-test-fortune-service</code> space. Two versions of these tests are executed against the application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the current version, in the <code>test-smoke</code> job.</p>
</li>
<li>
<p>the latest prod version, in the <code>test-rollback-smoke</code> job.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following image shows the tests in Concourse:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_smoke_tests.png" alt="fortune service smoke tests">
</div>
<div class="title">Figure 16. fortune-service Smoke Tests</div>
</div>
<div class="paragraph">
<p>In the test environment, we choose to verify that <code>fortune-service</code> is retrieving a fortune from <code>fortune-db</code>, and not returning its Hystrix fallback response. The following example defines this test:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package smoke;

import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)
@EnableAutoConfiguration
public class SmokeTests {

	@Value("${application.url}") String applicationUrl;

	RestTemplate restTemplate = new RestTemplate();

	@Test
	public void should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = this.restTemplate
				.getForEntity("http://" + this.applicationUrl + "/", String.class);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(200);

		// Filter out the known Hystrix fallback response
		BDDAssertions.then(response.getBody()).doesNotContain("The fortuneteller will be back soon.");
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="code-fortune-service-code-end-to-end-code-e2e-code-tests"><code>fortune-service</code> End-to-end (<code>e2e</code>) Tests</h6>
<div class="paragraph">
<p>Add your end-to-end tests so that they match the <code>e2e</code> profile, as defined in the <code>fortune-service</code> <code>pom.xml</code> file. These tests run on Concourse against the <code>fortune-service</code> application deployed in the Cloud Foundry <code>scp-stage</code> space. This space is shared, so we assume <code>greeting-ui</code> is also present.</p>
</div>
<div class="paragraph">
<p>The following image shows the tests in Concourse:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_e2e_tests.png" alt="fortune service e2e tests">
</div>
<div class="title">Figure 17. fortune-service E2E Tests</div>
</div>
<div class="paragraph">
<p>In the <code>e2e</code> environment, we choose to use a string replacement to obtain the URL for <code>greeting-ui</code>. We also choose to verify that we hit <code>fortune-db</code> and do not receive Hystrix fallback responses from either application. The following example shows this test:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package e2e;

import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)
@EnableAutoConfiguration
public class E2eTests {

	// The app is running in CF but the tests are executed from Concourse worker,
	// so the test will deduce the url to greeting-ui: it will assume the same host
	// as fortune-service, and simply replace "fortune-service" with "greeting-ui" in the url

	@Value("${application.url}") String applicationUrl;

	RestTemplate restTemplate = new RestTemplate();

	@Test
	public void should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = this.restTemplate
				.getForEntity("http://" + this.applicationUrl.replace("fortune-service", "greeting-ui") + "/", String.class);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(200);

		// Filter out the known Hystrix fallback responses from both fortune and greeting
		BDDAssertions.then(response.getBody()).doesNotContain("This fortune is no good. Try another.").doesNotContain("The fortuneteller will be back soon.");
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="code-greeting-ui-code-default-tests"><code>greeting-ui</code> Default Tests</h6>
<div class="paragraph">
<p>Add your unit and integration tests so that they match the default profile, as defined in the <code>greeting-ui</code> <code>pom.xml</code> file. These run on Concourse against the <code>greeting-ui</code> application that runs on the Concourse worker in the <code>build-and-upload</code> job.</p>
</div>
<div class="paragraph">
<p>As an example, we add one test that loads the context:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package io.pivotal;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = GreetingUIApplication.class)
public class GreetingUIApplicationTests {

    @Test
    public void contextLoads() throws Exception {

    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="code-greeting-ui-code-smoke-tests"><code>greeting-ui</code> Smoke Tests</h6>
<div class="paragraph">
<p>Add your smoke tests so that they match the smoke profile, as defined in the <code>greeting-ui</code> <code>pom.xml</code> file. These run on Concourse against the <code>greeting-ui</code> application deployed in the Cloud Foundry <code>scp-test-greeting-ui</code> space. Two versions of these tests run against the app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The current version, in the <code>test-smoke</code> job.</p>
</li>
<li>
<p>The latest prod version, in the <code>test-rollback-smoke</code> job.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following image shows the tests in Concourse:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_smoke_tests.png" alt="greeting ui smoke tests">
</div>
<div class="title">Figure 18. greeting-ui Smoke Tests</div>
</div>
<div class="paragraph">
<p>Since <code>fortune-service</code> is not deployed to the <code>scp-test-greeting-ui</code> space, we expect to receive the Hystrix fallback response defined in <code>greeting-ui</code>. Hence, our smoke test validates that condition:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package smoke;

import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)
@EnableAutoConfiguration
public class SmokeTests {

    @Value("${application.url}") String applicationUrl;

    RestTemplate restTemplate = new RestTemplate();

    @Test
    public void should_return_a_fallback_fortune() {
        ResponseEntity&lt;String&gt; response = this.restTemplate
                .getForEntity("http://" + this.applicationUrl + "/", String.class);

        BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(200);

        // Expect the hystrix fallback response
        BDDAssertions.then(response.getBody()).contains("This fortune is no good. Try another.");
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="code-greeting-ui-code-end-to-end-code-e2e-code-tests"><code>greeting-ui</code> End-to-end (<code>e2e</code>) Tests</h6>
<div class="paragraph">
<p>Add your end-to-end tests so that they match the <code>e2e</code> profile, as defined in the <code>greeting-ui</code> <code>pom.xml</code> file. These run on Concourse against the <code>greeting-ui</code> application deployed in the Cloud Foundry <code>scp-stage</code> space. This space is shared, so we assume <code>fortune-service</code> is also present.</p>
</div>
<div class="paragraph">
<p>The following image shows the tests in Concourse:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_e2e_tests.png" alt="greeting ui e2e tests">
</div>
<div class="title">Figure 19. greeting-ui E2E Tests</div>
</div>
<div class="paragraph">
<p>In the <code>e2e</code> environment, we choose to verify that we hit <code>fortune-service</code> and do not receive the Hystrix fallback response from <code>greeting-ui</code>. The following example shows the test:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package e2e;

import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)
@EnableAutoConfiguration
public class E2eTests {

	@Value("${application.url}") String applicationUrl;

	RestTemplate restTemplate = new RestTemplate();

	@Test
	public void should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = this.restTemplate
				.getForEntity("http://" + this.applicationUrl + "/", String.class);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(200);

		// Filter out the known Hystrix fallback response
		BDDAssertions.then(response.getBody()).doesNotContain("This fortune is no good. Try another.");
	}

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="2-3-enable-database-versioning">2.3 Enable Database Versioning</h5>
<div class="paragraph">
<p>At this point, we also incorporate <a href="https://flywaydb.org/">Flyway</a>, an OSS database migration tool, to track database schema versions and handle schema changes and data loading.</p>
</div>
<div class="paragraph">
<p>This change needs to be made only to <code>fortune-service</code>, since <code>fortune-service</code> owns the interaction with <code>fortune-db</code>.</p>
</div>
<div class="sect5">
<h6 id="add-flyway-dependency">Add Flyway Dependency</h6>
<div class="paragraph">
<p>We first add the Flyway dependency to the <code>fortune-service</code> <code>pom.xml</code>. We need not add a version as Spring Boot takes care of that for us. The following listing shows the Flyway dependency:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;
      &lt;artifactId&gt;flyway-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="create-flyway-migration">Create Flyway Migration</h6>
<div class="paragraph">
<p>Next, we create a migration directory and our initial migration file, following Flyway&#8217;s file naming convention. The following image shows the name of the file in context:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_flyway_file_name.png" alt="fortune service flyway file name">
</div>
<div class="title">Figure 20. fortune-service Flyway File Name</div>
</div>
<div class="paragraph">
<p>Note that the filename specifies the version (<code>V1</code>), followed by two underscore characters.</p>
</div>
<div class="paragraph">
<p>We place our <code>CREATE TABLE</code> and <code>INSERT</code> statements in our <code>src/main/resources/db/migration/V1__init.sql</code> file, as the following listing shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE fortune (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  text varchar(255) not null
);

INSERT INTO fortune (text) VALUES ('Do what works.');

INSERT INTO fortune (text) VALUES ('Do the right thing.');

INSERT INTO fortune (text) VALUES ('Always be kind.');

INSERT INTO fortune (text) VALUES ('You learn from your mistakes... You will learn a lot today.');

INSERT INTO fortune (text) VALUES ('You can always find happiness at work on Friday.');

INSERT INTO fortune (text) VALUES ('You will be hungry again in one hour.');

INSERT INTO fortune (text) VALUES ('Today will be an awesome day!');</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="disable-jpa-ddl-initialization">Disable JPA DDL Initialization</h6>
<div class="paragraph">
<p>Because we rely on Flyway to create and populate the schema, we need to disable JPA-based database initialization. We can set <code>ddl-auto</code> to <code>validate</code>, which validates the schema against the application entities and throws an error in case of a mismatch but does not actually generate the schema. The following snippet shows how to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">spring:
  jpa:
    hibernate:
      ddl-auto: validate</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are a few options for where to store the <code>ddl-auto</code> configuration, both in terms of location (in the <code>fortune-service</code> app or on the <code>app-config</code> GitHub repo) and in terms of file name. For this example, update the <code>application.yml</code> in the <code>fortune-service</code> app for local testing. Additionally, save these values in a new file called <code>application-flyway.yml</code> on your fork of <a href="https://github.com/ciberkleid/app-config"><code>app-config</code></a>.</p>
</div>
<div class="paragraph">
<p>By convention, <code>fortune-service</code> picks up the configurations in <code>application-flyway.yml</code> if the string <code>flyway</code> is in the list of active Spring profiles. Consequently, we can add <code>flyway</code> to the <code>SPRING_PROFILES_ACTIVE</code> environment variable in the <code>fortune-service</code> <code>manifest.yml</code>, as the following listing shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: flyway
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="remove-non-flyway-data-loading">Remove Non-Flyway Data Loading</h6>
<div class="paragraph">
<p>We can now remove the old code that populated the database. In our sample app, this was found in the <code>io.pivotal.FortuneServiceApplication</code> class. The following listing shows the code we now remove:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
    CommandLineRunner loadDatabase(FortuneRepository fortuneRepo) {
        return args -&gt; {
//            logger.debug("loading database..");
//            fortuneRepo.save(new Fortune(1L, "Do what works."));
//            fortuneRepo.save(new Fortune(2L, "Do the right thing."));
//            fortuneRepo.save(new Fortune(3L, "Always be kind."));
//            fortuneRepo.save(new Fortune(4L, "You learn from your mistakes... You will learn a lot today."));
//            fortuneRepo.save(new Fortune(5L, "You can always find happiness at work on Friday."));
//            fortuneRepo.save(new Fortune(6L, "You will be hungry again in one hour."));
//            fortuneRepo.save(new Fortune(7L, "Today will be an awesome day!"));
            logger.debug("record count: {}", fortuneRepo.count());
            fortuneRepo.findAll().forEach(x -&gt; logger.debug(x.toString()));
        };

    }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We also no longer need the <code>Fortune</code> entity constructors, so we can comment these out in the <code>io.pivotal.fortune.Fortune</code> class as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">//    public Fortune() {
//    }
//
//    public Fortune(Long id, String text) {
//        super();
//        this.id = id;
//        this.text = text;
//    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="flyway-integration-summary">Flyway Integration Summary</h6>
<div class="paragraph">
<p>With that, we have completed the setup for Flyway, and our database schema is now versioned. From this point onward, Spring Boot calls <code>Flyway.migrate()</code> to perform the database migration. As long as we follow Flyway conventions for future schema changes, Flyway takes care of tracking the schema version and migrating the database for us.</p>
</div>
<div class="paragraph">
<p>From a rollback perspective, Cloud Pipelines includes two jobs in the <code>test</code> phase (<code>test-rollback-deploy</code> and <code>test-rollback-smoke</code>), wherein it validates that the latest prod jar works against the newly updated database. The purpose is to ensure that we can roll back the application in prod if a problem is discovered after the prod database schema has been updated and avoid the burden of rolling back the database.</p>
</div>
<div class="paragraph">
<p>See <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-use-a-higher-level-database-migration-tool">Spring Boot database initialization with Flyway</a> for further information, including Flyway configuration options.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="2-4-push-changes-to-github">2.4 Push Changes to GitHub</h5>
<div class="paragraph">
<p>For <code>greeting-ui</code>, you should push the following new or modified files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pom.xml</code></p>
</li>
<li>
<p><code>src/test/java/e2e/E2eTests.java</code></p>
</li>
<li>
<p><code>src/test/java/io/pivotal/GreetingUIApplicationTests.java</code></p>
</li>
<li>
<p><code>src/test/java/smoke/SmokeTests.java</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For <code>fortune-service</code>, you should be pushing the following new or modified files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pom.xml</code></p>
</li>
<li>
<p><code>src/test/java/e2e/E2eTests.java</code></p>
</li>
<li>
<p><code>src/test/java/io/pivotal/FortuneServiceApplicationTests.java</code></p>
</li>
<li>
<p><code>src/test/java/smoke/SmokeTests.java</code></p>
</li>
<li>
<p><code>src/main/resources/db/migration/V1__init.sql</code></p>
</li>
<li>
<p><code>src/main/resources/application.yml</code></p>
</li>
<li>
<p><code>manifest.yml</code></p>
</li>
<li>
<p><code>src/main/java/io/pivotal/FortuneServiceApplication.java</code></p>
</li>
<li>
<p><code>src/main/java/io/pivotal/fortune/Fortune.java</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For <code>app-config</code>, you should be pushing the following new:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>application-flyway.yml</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="2-5-re-run-the-pipelines">2.5 Re-run the Pipelines</h5>
<div class="paragraph">
<p>Run through the pipelines again and view the output for the jobs that run the default, smoke, and end-to-end (<code>e2e</code>) tests. You should see that the tests we added in this stage were run.</p>
</div>
<div class="paragraph">
<p>As you run through the pipelines a second time, you should see the smoke tests from the latest prod version run against the database in the <code>test-rollback-smoke</code> job. In this case, there is no schema upgrade. Nonetheless, the tests confirm that the latest prod version of the app can be used with the current database schema.</p>
</div>
<div class="paragraph">
<p>You can see the database version information stored in the database by Flyway either by querying the database itself or by hitting the flyway endpoint on the <code>fortune-service</code> URL. The following image shows an example from the <code>scp-stage</code> environment:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_flyway_schema_info.png" alt="fortune service flyway schema info">
</div>
<div class="title">Figure 21. fortune-service Flyway Schema Info</div>
</div>
</div>
<div class="sect4">
<h5 id="stage-two-recap-and-next-steps">Stage Two Recap and Next Steps</h5>
<div class="paragraph">
<p>What have we accomplished?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increased the effectiveness of the pipelines and our confidence in them by integrating our applications with the testing strategy built into Cloud Pipelines.</p>
</li>
<li>
<p>Established a standard approach to organizing tests, which brings consistency within and across development teams.</p>
</li>
<li>
<p>Enabled auto-managed database versioning and backward compatibility testing that alleviates database schema management throughout the release management lifecycle.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can now add any unit, integration, smoke, and end-to-end tests to our code base and have a high level of reliability and confidence in our pipelines. We are also better positioned to ensure that our development teams conform to these practices, given the structure established by Cloud Pipelines and the fast feedback and visibility we gain from the pipelines as they execute the tests.</p>
</div>
<div class="paragraph">
<p>However, we could benefit further by incorporating contracts to define and test the API integration points between applications. We do this in Stage Three of the application migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tutorial-stage-three">3.7.4. Stage Three: Contracts</h4>
<div class="paragraph">
<p>In this stage, we introduce contract-based programming practices into our sample application. Doing so improves API management capabilities, including defining, communicating, and testing API semantics. It also lets us catch breaking API changes (that is, we can validate API backward compatibility) in the build phase. This extends the effectiveness of the pipelines, encourages better communication and programming practices across development teams, and provides faster feedback to developers.</p>
</div>
<div class="paragraph">
<p>We will integrate Spring Cloud Contract and add contracts, stubs, and a stub runner. We will also now complete and make use of the <code>apicompatibility</code> profile defined in <a href="#tutorial-stage-two">Stage Two: Tests</a>.</p>
</div>
<div class="sect4">
<h5 id="3-1-create-a-contract">3.1 Create a Contract</h5>
<div class="paragraph">
<p>We start by creating the contract for the interaction between <code>greeting-ui</code> and <code>fortune-service</code>. The contract should describe the following expectation: <code>greeting-ui</code> makes a <code>GET</code> request to the root URL of <code>fortune-service</code> and expects a response with status 200 and a string (<code>new fortune</code>) in the body</p>
</div>
<div class="paragraph">
<p>We code this buy using groovy syntax as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">import org.springframework.cloud.contract.spec.Contract

Contract.make {
    description("""
should return a fortune string
""")
    request {
        method GET()
        url "/"
    }
    response {
        status 200
        body "new fortune"
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Save this contract in the <code>fortune-service</code> code base in the following location (which is compliant with Spring Cloud Contract convention): <code>src/test/resources/contracts/&lt;service-name&gt;/&lt;contract-file&gt;</code>. The following image shows the contract file in its location within an IDE:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_contract_file.png" alt="fortune service contract file">
</div>
<div class="title">Figure 22. fortune-service Flyway Contract File</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can optionally enable your IDE to assist with contract syntax by adding the Spring Cloud Contract Verifier to your <code>pom.xml</code> file. It is pluggable, and includes groovy and pact by default. The following element shows the dependency to add:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-contract-verifier&lt;/artifactId&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="3-2-create-a-base-class-for-contract-tests">3.2 Create a Base Class for Contract Tests</h5>
<div class="paragraph">
<p>Now that we have a coded contract, we want to enable auto-generation of contract-based tests. The auto-generation, which we will configure in the next steps, requires a base class that stubs out the service that satisfies the API call, so that we can run the test without external dependencies (for example, the database). The objective is to focus on testing API semantics.</p>
</div>
<div class="paragraph">
<p>We create the base class in the <code>fortune-service</code> test package as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package io.pivotal.fortune;

import io.restassured.module.mockmvc.RestAssuredMockMvc;
import org.junit.Before;
import org.mockito.BDDMockito;

public class BaseClass {

    @Before
    public void setup() {
        FortuneService service = BDDMockito.mock(FortuneService.class);
        BDDMockito.given(service.getFortune()).willReturn("foo fortune");
        RestAssuredMockMvc.standaloneSetup(new FortuneController(service));
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="3-3-enable-automated-contract-based-testing">3.3 Enable Automated Contract-based Testing</h5>
<div class="paragraph">
<p>Now that we have a contract and a base class, we can use the Spring Cloud Contract Maven plugin to auto-generate contract tests, stubs, and a stub jar.</p>
</div>
<div class="paragraph">
<p>First we add the Spring Cloud Contract version to the list of properties in the <code>fortune-service</code> <code>pom.xml</code> file, since we will reference it when we enable the Spring Cloud Contract maven plugin. To do so, we add the <code>&lt;spring-cloud-contract.version&gt;</code> to the <code>properties</code> element, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">  &lt;properties&gt;
...
    &lt;spring-cloud-contract.version&gt;1.2.1.RELEASE&lt;/spring-cloud-contract.version&gt;
...
&lt;/properties&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, we edit the <code>default</code> profile in the <code>fortune-service</code> <code>pom.xml</code> file to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a plugin block for Spring Cloud Contract maven plugin.</p>
</li>
<li>
<p>Configure it to use our base class (<code>io.pivotal.fortune.BaseClass</code>) to generate tests.</p>
</li>
<li>
<p>Configure it to place auto-generated tests in the <code>io.pivotal.fortune.contracttests</code> test package.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the package of the contract tests is included by the <code>include</code> filter in the <code>default</code> profile, so these tests run against the application during the <code>build-and-upload</code> job. For <code>fortune-service</code>, this serves to validate that the application conforms to the contract.</p>
</div>
<div class="paragraph">
<p>The following listing shows the complete profile:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;profile&gt;
      &lt;id&gt;default&lt;/id&gt;
      &lt;activation&gt;
        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
      &lt;/activation&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;**/*Tests.java&lt;/include&gt;
                &lt;include&gt;**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
              &lt;excludes&gt;
                &lt;exclude&gt;**/smoke/**&lt;/exclude&gt;
                &lt;exclude&gt;**/e2e/**&lt;/exclude&gt;
              &lt;/excludes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
          &lt;/plugin&gt;
          &lt;!--Spring Cloud Contract maven plugin --&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-contract-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud-contract.version}&lt;/version&gt;
            &lt;extensions&gt;true&lt;/extensions&gt;
            &lt;configuration&gt;
              &lt;baseClassForTests&gt;io.pivotal.fortune.BaseClass&lt;/baseClassForTests&gt;
              &lt;basePackageForTests&gt;io.pivotal.fortune.contracttests&lt;/basePackageForTests&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When the app is built, the Spring Cloud Contract maven plugin also now produces a stub and a stub jar that contains the contract and stub. This stub jar is uploaded to Bintray, along with the usual app jar. As we see shortly, this stub jar can be used by the <code>greeting-ui</code> development team while they wait for <code>fortune-service</code> to be completed. In other words, this gives the <code>greeting-ui</code> development team a producer to test against that is based on a mutually agreed-upon contract without the lead time of having to wait for <code>fortune-service</code> team to implement anything more than a base class and without having to manually stub out calls to <code>fortune-service</code> based on arbitrary or static responses.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Package the project locally (run <code>mvn package</code>) to observe the tests, stubs, and stub jar that the Spring Cloud Contract Maven plugin generates. See the following image for reference:
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_generated_tests.png" alt="fortune service generated tests">
</div>
<div class="title">Figure 23. Generated Tests and Stubs</div>
</div>
</div>
<div class="sect4">
<h5 id="3-4-enable-backward-compatibility-api-check">3.4 Enable backward compatibility API check</h5>
<div class="paragraph">
<p>To enable Cloud Pipelines to catch any breaking API changes during the the API compatibility check in the <code>build-and-upload</code> job, we add the Spring Cloud Contract Maven plugin to the <code>apicompatibility</code> profile as well.</p>
</div>
<div class="paragraph">
<p>In this case, we want the plugin to generate tests based on contracts outside of the project (the ones from the latest prod version), so we configure the plugin to download the latest prod stub jar, which contains the old contract. The plugin uses the old contract and the specified base class (which, in our example, is the same as the one in the previous step) to generate contract tests. These tests are run against the new code to validate that it is still compatible with consumers that comply with the prior contract. This ensures backward compatibility for the API.</p>
</div>
<div class="paragraph">
<p>In short, we edit the <code>apicompatibility</code> profile in the <code>fortune-service</code> <code>pom.xml</code> file to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a plugin block for Spring Cloud Contract Maven plugin.</p>
</li>
<li>
<p>Configure it to download the latest prod stub jar from Bintray to obtain the old contract.</p>
</li>
<li>
<p>Configure it to use our base class (<code>io.pivotal.fortune.BaseClass</code>) to generate tests (we use the same one as in the prior step).</p>
</li>
<li>
<p>Configure it to place auto-generated tests in the <code>io.pivotal.fortune.contracttests</code> test package.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the package of the contract tests matches the <code>include</code> filter in the <code>apicompatibility</code> profile, so these tests run against the app during the the API compatibility check during the <code>build-and-upload</code> job. For <code>fortune-service</code>, this serves to validate that the app conforms to the old contract.</p>
</div>
<div class="paragraph">
<p>The following listing shows the complete profile:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;profile&gt;
      &lt;id&gt;apicompatibility&lt;/id&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;includes&gt;
                &lt;include&gt;**/contracttests/**/*Tests.java&lt;/include&gt;
                &lt;include&gt;**/contracttests/**/*Test.java&lt;/include&gt;
              &lt;/includes&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
          &lt;!--Spring Cloud Contract maven plugin --&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-contract-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud-contract.version}&lt;/version&gt;
            &lt;extensions&gt;true&lt;/extensions&gt;
            &lt;configuration&gt;
              &lt;contractsRepositoryUrl&gt;${repo.with.binaries}&lt;/contractsRepositoryUrl&gt;
              &lt;contractDependency&gt;
                &lt;groupId&gt;${project.groupId}&lt;/groupId&gt;
                &lt;artifactId&gt;${project.artifactId}&lt;/artifactId&gt;
                &lt;classifier&gt;stubs&lt;/classifier&gt;
                &lt;version&gt;${latest.production.version}&lt;/version&gt;
              &lt;/contractDependency&gt;
              &lt;contractsPath&gt;/&lt;/contractsPath&gt;
              &lt;baseClassForTests&gt;io.pivotal.fortune.BaseClass&lt;/baseClassForTests&gt;
              &lt;basePackageForTests&gt;io.pivotal.fortune.contracttests&lt;/basePackageForTests&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Cloud Pipelines dynamically injects the values for <code>${repo.with.binaries}</code> and <code>${latest.production.version}</code>. You can run this locally by providing these values manually as system properties in the Maven command.</p>
</div>
</div>
<div class="sect4">
<h5 id="3-5-push-changes-to-github">3.5 Push Changes to GitHub</h5>
<div class="paragraph">
<p>All changes in Stage Three thus far are in <code>fortune-service</code>. At this point, you should be pushing the following new or modified files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pom.xml</code></p>
</li>
<li>
<p><code>src/test/resources/contracts/greeting-ui/shouldReturnAFortune.groovy</code></p>
</li>
<li>
<p><code>src/test/java/io/pivotal/fortune/BaseClass.java</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="3-6-re-run-the-code-fortune-service-code-pipeline">3.6 Re-run the <code>fortune-service</code> Pipeline</h5>
<div class="paragraph">
<p>Run through the <code>fortune-service</code> pipeline to generate stubs. The following output from the <code>build-and-upload</code> job shows the auto-generation of tests and stubs:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/fortune_service_build_and_upload_test_and_stub_generation.png" alt="fortune service build and upload test and stub generation">
</div>
<div class="title">Figure 24. fortune-service build-and-upload Test and Stub Generation</div>
</div>
<div class="paragraph">
<p>You should also see output in the <code>build-and-upload</code> job that shows the execution of these tests against the code.</p>
</div>
<div class="paragraph">
<p>Additionally, you should see the stub jar uploaded to Bintray along with the usual app jar.</p>
</div>
<div class="paragraph">
<p>Finally, as you run through the pipeline a second time, you should see that the contract tests from the latest prod version run against the new code in the output of the the API compatibility check during the <code>build-and-upload</code> job. In this case, there is no API change. Nonetheless, the tests confirm that the latest prod version of the API can be used with the current code base.</p>
</div>
</div>
<div class="sect4">
<h5 id="3-7-enable-stubs-for-integration-tests">3.7 Enable Stubs for Integration Tests</h5>
<div class="paragraph">
<p>Now we turn our attention to <code>greeting-ui</code>.</p>
</div>
<div class="paragraph">
<p>The following image compares the path of a request through <code>greeting-ui</code> in the build phase, both with and without stubs:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_build_flow.png" alt="greeting ui build flow">
</div>
<div class="title">Figure 25. greeting-ui Build Flow</div>
</div>
<div class="paragraph">
<p>Without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code>greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract. In this case, the stubs are loaded into the <code>greeting-ui</code> process. This leads us to our next task: Loading the stubs produced by <code>fortune-service</code>.</p>
</div>
<div class="sect5">
<h6 id="enable-the-in-process-stub-runner">Enable the in-process Stub Runner</h6>
<div class="paragraph">
<p>To load the stubs into the <code>greeting-ui</code> process, we must enable the Spring Cloud Contract Stub Runner dependency. This dependency start ans in-process stub runner that automatically configures Wiremock.</p>
</div>
<div class="paragraph">
<p>Add the following dependency to the <code>greeting-ui</code> <code>pom.xml</code> file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
 &lt;artifactId&gt;spring-cloud-starter-contract-stub-runner&lt;/artifactId&gt;
 &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="add-integration-tests-aligned-with-the-contract">Add Integration Tests Aligned with the Contract</h6>
<div class="paragraph">
<p>Next, we add integration tests to <code>greeting-ui</code> to test for the expected response declared in the contract.</p>
</div>
<div class="paragraph">
<p>Add the following class to the <code>test</code> package in <code>greeting-ui</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package io.pivotal.fortune;

import io.pivotal.GreetingUIApplication;
import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = GreetingUIApplication.class, webEnvironment = SpringBootTest.WebEnvironment.NONE,
        properties = {"spring.application.name=greeting-ui", "spring.cloud.circuit.breaker.enabled=false", "hystrix.stream.queue.enabled=false"})
@AutoConfigureStubRunner(ids = {"io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION"},
        repositoryRoot = "${REPO_WITH_BINARIES}"
        //workOffline = true
)

public class FortuneServiceTests {

    @Autowired FortuneService fortuneService;

    @Test
    public void shouldSendRequestToFortune() {
        // when
        String fortune = fortuneService.getFortune();
        // then
        BDDAssertions.then(fortune).isEqualTo("foo fortune");
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point, we can get through the build phase for <code>greeting-ui</code>, and the integration tests run against the <code>fortune-service</code> stubs that runs in the <code>greeting-ui</code> process on the Concourse worker.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Notice the configuration of <code>@AutoConfigureStubRunner</code>. You can replace the version with a <code>+</code> sign if using Artifactory or Nexus and it automatically chooses the latest available version on the maven repo.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Setting <code>workOffline=true</code> (commented out but shown earlier for informational purposes) would make the stub runner get the stubs from the local Maven repository. This is useful for local testing. Alternatively, set the <code>$REPO_WITH_BINARIES</code> environment variable to the value used in the credentials file before doing a local Maven build. Then the local build will download the stubs from your remote Maven repository (for example, Bintray).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="3-8-enable-stubs-for-smoke-tests">3.8 Enable Stubs for Smoke Tests</h5>
<div class="paragraph">
<p>The following image compares the path of a request through <code>greeting-ui</code> in the test phase, both with and without stubs. Note that in the build phase, where the app process runS on the Concourse worker, we ran the stubs in the same process. In the test environment (Cloud Foundry), we run the stubs in a separate process by using a standalone stub runner application. The following image shows the test flow for the <code>greeting-ui</code> application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_test_flow.png" alt="greeting ui test flow">
</div>
<div class="title">Figure 26. greeting-ui Test Flow</div>
</div>
<div class="paragraph">
<p>As in the build phase, without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code>greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract.</p>
</div>
<div class="paragraph">
<p>We rely on Cloud Pipelines to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy a stub runner application.</p>
</li>
<li>
<p>Provide the stub runner application with the necessary information to download the stubs.</p>
</li>
<li>
<p>Open a port on the stub runner application for each stub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We rely on the stub runner application to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the stubs from our Maven repository (Bintray).</p>
</li>
<li>
<p>Expose each stub on a separate port.</p>
</li>
<li>
<p>Register each stub in the Service Discovery server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following steps describe how to configure stubs for smoke tests.</p>
</div>
<div class="sect5">
<h6 id="provide-a-stand-alone-stub-runner-app-jar">Provide a Stand-alone Stub Runner App Jar</h6>
<div class="paragraph">
<p>In the <a href="#tutorial-prep">Prep step</a> for this tutorial, you cloned the <a href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot"><code>cloudfoundry-stub-runner-boot</code></a> repo to your local machine. The next step is to build this application and upload it to Bintray to make the jar available to Cloud Pipelines.</p>
</div>
<div class="paragraph">
<p>As mentioned in <a href="#tutorial-stage-one">Stage One: Scaffolding</a> of this tutorial, Bintray requires that a package exist before any application artifacts can be uploaded. Log into the Bintray UI and create a package for <code>cloudfoundry-stub-runner-boot</code>. If you forked this repo, you can use the <code>Import from GitHub</code> option. Otherwise, create the package manually and choose any license (for example, Apache 2.0).</p>
</div>
<div class="paragraph">
<p>Now you are ready to build and upload this app to Bintray. Edit the following script (which shows cloning, building, and uploading) to match your Bintray URL, the Bintray ID in your <code>~/.m2/settings/xml</code> file, and the <code>cloudfoundry-stub-runner-boot</code> repository URL (if you chose to fork it):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"># Edit to match your Bintray URL and M2 repo ID setting (check your ~/.m2/settings.xml file)
MAVEN_REPO_URL=https://api.bintray.com/maven/ciberkleid/maven-repo/cloudfoundry-stub-runner-boot
MAVEN_REPO_ID=bintray

# Clone cloudfoundry-stub-runner-boot
git clone https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot.git
cd cloudfoundry-stub-runner-boot

# Build and upload
./mvnw clean deploy -Ddistribution.management.release.url="${MAVEN_REPO_URL}" -Ddistribution.management.release.id="${MAVEN_REPO_ID}"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should now see the <code>cloudfoundry-stub-runner-boot</code> artifacts uploaded on Bintray.</p>
</div>
</div>
<div class="sect5">
<h6 id="provide-stand-alone-stub-runner-application-manifest">Provide Stand-alone Stub Runner Application Manifest</h6>
<div class="paragraph">
<p>Next, we add a manifest file for the stub runner application for deployment to Cloud Foundry.</p>
</div>
<div class="paragraph">
<p>Place this file in the <code>greeting-ui</code> repo. The file name and location can be your choice. For this example, we use <code>sc-pipelines/manifest-stubrunner.yml</code>. The following image shows the file in the appropriate folder:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_stubrunner_manifest.png" alt="greeting ui stubrunner manifest">
</div>
<div class="title">Figure 27. greeting-ui Stub Runner Manifest</div>
</div>
<div class="paragraph">
<p>We populate this <code>manifest-stubrunner.yml</code> with the content shown in the next listing so that the stub runner binds to <code>service-registry</code>. The stub runner registers the <code>fortune-service</code> stub there so that <code>greeting-ui</code> can discover it in the same way it discovers the actual <code>fortune-service</code> app endpoint in stage and prod. From the <code>greeting-ui</code> perspective, there is no difference in how it interacts with Eureka and the stub runner application in test and the way it interacts with Eureka and the <code>fortune-service</code> application in stage and prod. The following listing shows the content of <code>manifest-stubrunner.yml</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: stubrunner
  timeout: 120
  services:
  - service-registry
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io
----</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="provide-a-stub-runner-jar-and-manifest-information-to-the-pipeline">Provide a Stub Runner Jar and Manifest Information to the Pipeline</h6>
<div class="paragraph">
<p>Now that we have a jar file and a manifest file for our stub runner application, we need to provide this information to our <code>greeting-ui</code> pipeline so that the pipeline downloads the jar from Bintray and deploys it to Cloud Foundry. We do this through the <code>greeting-ui</code> <code>sc-pipelines.yml</code> file. We add an entry to the list of services in the <code>test</code> section, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">    - name: stubrunner
      type: stubrunner
      coordinates: io.pivotal:cloudfoundry-stub-runner-boot:0.0.1.M1
      pathToManifest: sc-pipelines/manifest-stubrunner.yml</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that <code>name</code> matches the name of the application in <code>manifest-stubrunner.yml</code>, <code>coordinates</code> corresponds to the jar coordinates of the Maven repository, and <code>pathToManifest</code> matches our chosen fie name for the stub runner application manifest.</p>
</div>
<div class="paragraph">
<p>Note also the <code>type</code> is set to <code>stubrunner</code>, which Cloud Pipelines will recognize as a stanalone stub runner app and treat accordingly.</p>
</div>
</div>
<div class="sect5">
<h6 id="provide-stub-configuration-for-the-stub-runner-application">Provide Stub Configuration for the Stub Runner Application</h6>
<div class="paragraph">
<p>The final steps in the configuration of the stand-alone stub runner app are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable the stub runner app to download the <code>fortune-service</code> stub from Bintray.</p>
</li>
<li>
<p>Open a second port on the container to receive requests for this stub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To accomplish this, we put stub and port configuration information into the properties section of the <code>greeting-ui</code> <code>pom.xml</code> file, by using a property called <code>stubrunner.ids</code>. This property can accept a list of stubrunner IDs. However, for this tutorial, we only have one, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">  &lt;properties&gt;
...
    &lt;!--Tell stub runner app to start this stub--&gt;
    &lt;stubrunner.ids&gt;io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION:stubs:10000&lt;/stubrunner.ids&gt;
  &lt;/properties&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Cloud Pipelines uses this information in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It provides this information to the stub runner application through the application&#8217;s environment variables.</p>
<div class="ulist">
<ul>
<li>
<p>Cloud Pipelines also provides the <code>$REPO_WITH_BINARIES</code> as an environment variable for the stub runner application.</p>
</li>
<li>
<p>The stub runner application uses this information to download the stub from Bintray and expose it on the specified port.</p>
</li>
</ul>
</div>
</li>
<li>
<p>It opens the additional port specified on the stub runner app and map a new route to it.</p>
<div class="ulist">
<ul>
<li>
<p>The format for each route is <code>&lt;stub-runner-app-name&gt;-&lt;hostname-uuid&gt;-&lt;env&gt;-&lt;app-name&gt;-&lt;port&gt;.&lt;domain&gt;</code>.</p>
</li>
<li>
<p>In our example, this would be <code>stubrunner-cyi-test-greeting-ui-10000.cfapps.io</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since we bound our stub runner application to <code>service-registry</code> (Eureka), the stub runner application registers the stub URL under the <code>FORTUNE-SERVICE</code> application name on Eureka, as the following image shows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/cf-migration/greeting_ui_stub_runner_eureka_registration.png" alt="greeting ui stub runner eureka registration">
</div>
<div class="title">Figure 28. greeting-ui Stub Runner Eureka Registration</div>
</div>
<div class="paragraph">
<p>This completes the process of configuring the stand-alone stub runner application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can automate the port configuration by Cloud Pipelines in the future such that you need not include the port in <code>stubrunner.ids</code>. However, for the moment, we are required to specify the port each stub should use.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="edit-smoke-tests-to-align-with-the-contract">Edit Smoke Tests to Align with the Contract</h6>
<div class="paragraph">
<p>Finally, we edit our smoke tests for <code>greeting-ui</code> to ensure the response does not contain the Hystrix fallback, since we are now expecting a response from the stub. The following listing shows the edited smoke tests:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package smoke;

import org.assertj.core.api.BDDAssertions;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)
@EnableAutoConfiguration
public class SmokeTests {

	@Value("${application.url}") String applicationUrl;

	RestTemplate restTemplate = new RestTemplate();

	@Test
	public void should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = this.restTemplate
				.getForEntity("http://" + this.applicationUrl + "/", String.class);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(200);

		// Filter out the known Hystrix fallback response
		BDDAssertions.then(response.getBody()).doesNotContain("This fortune is no good. Try another.");
	}

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this case, in contrast to the integration test we created earlier for <code>greeting-ui</code>, we do not include <code>@AutoConfigureStubRunner</code>, because we are using a standalone stub runner application.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="3-9-push-changes-to-github">3.9 Push Changes to GitHub</h5>
<div class="paragraph">
<p>Push contract-based changes for <code>greeting-ui</code>. You should be pushing the following new or modified files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pom.xml</code></p>
</li>
<li>
<p><code>sc-pipelines.yml</code></p>
</li>
<li>
<p><code>sc-pipelines/manifest-stubrunner.yml</code></p>
</li>
<li>
<p><code>src/test/java/io/pivotal/fortune/FortuneServiceTests.java</code></p>
</li>
<li>
<p><code>src/test/java/smoke/SmokeTests.java</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this point, we can run through the full pipeline for <code>greeting-ui</code> and leverage the contract-based stub in both the build and test environments.</p>
</div>
</div>
<div class="sect4">
<h5 id="stage-three-recap">Stage Three Recap</h5>
<div class="paragraph">
<p>What have we accomplished?</p>
</div>
<div class="paragraph">
<p>By implementing a contract-driven approach with auto-generation of tests and stubs, we have introduced a clean, structured, and reliable way to define, communicate, document, manage, and test APIs. The benefits include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inter-team communication can be simpler.</p>
<div class="ulist">
<ul>
<li>
<p>Consumer and producer teams can now communicate requirements through coded contracts.</p>
</li>
<li>
<p>The inventory of contracts serves as a record and reference of the agreed-upon APIs.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Developer productivity will increase.</p>
<div class="ulist">
<ul>
<li>
<p>Producers can quickly and easily generate contract-based stubs.</p>
</li>
<li>
<p>Consumers no longer have to manually stub out APIs and write tests with arbitrary hard-coded responses. Instead, they can use the auto-generated stubs and test for contract-based responses.</p>
</li>
<li>
<p>Both producers and consumers can validate their code complies with the contract.</p>
</li>
<li>
<p>Producers can verify backward compatibility of API changes.</p>
</li>
<li>
<p>Troubleshooting will be easier.</p>
</li>
<li>
<p>Failure and feedback will be faster.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conclusion">3.8. Conclusion</h3>
<div class="paragraph">
<p>This concludes the tutorial on migrating apps for Cloud Pipelines for Cloud Foundry.</p>
</div>
<div class="paragraph">
<p>Moving forward, the refactoring work shown here can be incorporated into your and your team&#8217;s standard practices. We recommend the following practices:</p>
</div>
<div class="paragraph">
<p><strong>Good:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Maven or Gradle wrappers.</p>
</li>
<li>
<p>Include a Cloud Foundry manifest file in your application repository.</p>
</li>
<li>
<p>Include a pipeline descriptor (<code>sc-manifest.yml</code>) in your app repository.</p>
</li>
<li>
<p>Create an empty <code>version</code> branch in your application repository.</p>
</li>
<li>
<p>Include artifact repository configuration in the <code>pom.xml</code> file.</p>
</li>
<li>
<p>Align your Cloud Foundry spaces with the Cloud Pipelines model (isolated test space and shared stage and prod spaces).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Better</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include <code>default</code>, <code>apicompatibility</code>, <code>smoke</code>, and <code>e2e</code> profiles in the <code>pom.xml</code> file.</p>
</li>
<li>
<p>Organize tests accordingly in your application repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Best</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a database migration tool, such as Flyway.</p>
</li>
<li>
<p>Use contract-based API programming.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementing all the <strong>&#8220;good&#8221;</strong> practices positions you to instantly create pipelines for your applications by using Cloud Pipelines. This is a huge win in terms of consistency and productivity and standardization across development teams. Of course, this is an open source project, so you can modify it to meet your needs.</p>
</div>
<div class="paragraph">
<p>Implementing the <strong>&#8220;better&#8221;</strong> practices ensures the proper tests get run at the proper time. At that point, you can add as much test coverage as you need to have high confidence in your pipelines.</p>
</div>
<div class="paragraph">
<p>Implementing the <strong>&#8220;best&#8221;</strong> practices gives you additional confidence in your pipeline and encourages better programming practices for database version and API management across development teams. It also gives you higher confidence in your pipelines and lets you avoid the cumbersome business of rolling back a database.</p>
</div>
<div class="paragraph">
<p>Happy coding!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concourse-pipeline-cf">4. Concourse Pipeline (Cloud Foundry)</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In this chapter, we assume that you deploy your application
to Cloud Foundry PaaS.
</td>
</tr>
</table>
</div>
<div id="concourse" class="paragraph">
<p>The Cloud Pipelines repository contains opinionated
Concourse pipeline definitions. Those jobs form an empty pipeline and an
opinionated sample pipeline one that you can use in your company.</p>
</div>
<div class="paragraph">
<p>There following projects take part in the  <code>microservice setup</code> for this demo.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics">Github Analytics</a>: The app that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-eureka">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and uses Eureka and Messaging. This is an infrastructure application.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="concourse-pipeline-step-by-step-cf">4.1. Step-by-step</h3>
<div class="paragraph">
<p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#concourse-fork-cf">Fork repos</a></p>
</li>
<li>
<p><a href="#concourse-start-cf">Start Concourse and Artifactory</a></p>
</li>
<li>
<p><a href="#concourse-deploy-cf">Deploy infra to Artifactory</a></p>
</li>
<li>
<p><a href="#concourse-pcfdev-cf">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></p>
</li>
<li>
<p><a href="#concourse-fly-cf">Setup the <code>fly</code> CLI</a></p>
</li>
<li>
<p><a href="#concourse-credentials-cf">Setup your <code>credentials.yml</code></a></p>
</li>
<li>
<p><a href="#concourse-build-cf">Build the Pipeline</a></p>
</li>
<li>
<p><a href="#concourse-run-cf">Run the <code>github-webhook</code> Pipeline</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="concourse-fork-cf">4.1.1. Fork Repositories</h4>
<div class="paragraph">
<p>Four applications compose the pipeline</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook">Github Webhook</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics/">Github Analytics</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-eureka">Github Eureka</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot">Github Stub Runner Boot</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to fork only the following repositories, because only then can you tag and push the tag to the repository:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook">Github Webhook</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics/">Github Analytics</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="concourse-start-cf">4.1.2. Start Concourse and Artifactory</h4>
<div class="paragraph">
<p>You can run Concourse + Artifactory locally. To do so, run the
<code>start.sh</code> script from this repository. The following listing shows the script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-cloud/spring-cloud-pipelines
cd spring-cloud-pipelines/concourse
./setup_docker_compose.sh
./start.sh 192.168.99.100</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>setup_docker_compose.sh</code> script should be run only once, to allow
generation of keys.</p>
</div>
<div class="paragraph">
<p>The <code>192.168.99.100</code> param is an example of an external URL of Concourse
(equal to the Docker-Machine IP in this example).</p>
</div>
<div class="paragraph">
<p>Then Concourse runs on port <code>8080</code>, and Artifactory runs on <code>8081</code>.</p>
</div>
<div class="sect4">
<h5 id="concourse-deploy-cf">Deploy the infra JARs to Artifactory</h5>
<div class="paragraph">
<p>When Artifactory is running, run the <code>tools/deploy-infra.sh</code> script from this repo.
The following listing shows the script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-cloud/spring-cloud-pipelines
cd spring-cloud-pipelines/
./tools/deploy-infra.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As a result, both <code>eureka</code> and <code>stub runner</code> repos are cloned, built,
and uploaded to Artifactory.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concourse-pcfdev-cf">4.1.3. Start PCF Dev</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can skip this step if you have CF installed and do not want to use PCF Dev.
The only thing you have to do is to set up spaces.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Servers often run run out of resources at the stage step.
If that happens, <a href="#resources">clear some apps from PCF Dev and continue</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have to download and start PCF Dev, as described  <a href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev">here.</a></p>
</div>
<div class="paragraph">
<p>The default credentials for PCF Dev are as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can start the PCF Dev as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf dev start</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You must create three separate spaces, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-test
cf set-space-role user pcfdev-org pcfdev-test SpaceDeveloper
cf create-space pcfdev-stage
cf set-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf set-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also run the <code>./tools/cf-helper.sh setup-spaces</code> script to create the spaces.</p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-fly-cf">4.1.4. Setup the <code>fly</code> CLI</h4>
<div class="paragraph">
<p>If you go to the Concourse website, you should see something resembling the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/running_concourse.png" alt="running concourse">
</div>
</div>
<div class="paragraph">
<p>You can click one of the icons (depending on your OS) to download <code>fly</code>, which is the Concourse CLI. Once you download that (and maybe, depending on your OS, add it to your PATH) you can run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">fly --version</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If <code>fly</code> is properly installed, it should print out the version.</p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-credentials-cf">4.1.5. Set up Your <code>credentials.yml</code> File</h4>
<div class="paragraph">
<p>The repository comes with <code>credentials-sample-cf.yml</code>, which is set up with sample data (mostly credentials) that are applicable for PCF Dev. Copy this file to a new file called <code>credentials.yml</code> (the file is added to <code>.gitignore</code> so that you cannot push it with your passwords) and edit it as you wish. For our demo, set up the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>app-url</code>: URL pointing to your forked <code>github-webhook</code> repository.</p>
</li>
<li>
<p><code>github-private-key</code>: Your private key to clone and tag GitHub repositorys.</p>
</li>
<li>
<p><code>repo-with-binaries</code>: The IP is set to the defaults for Docker Machine. You should update it to point to your setup.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you do not have a Docker Machine, run th <code>./whats_my_ip.sh</code> script to
get an external IP that you can pass to your <code>repo-with-binaries</code>, instead of the default
Docker Machine IP.</p>
</div>
<div class="paragraph">
<p>The following table describes the environment variables required by the scripts:</p>
</div>
<table class="tableblock frame-topbot grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Property Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BUILD_OPTIONS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional options you would like to pass to the Maven / Gradle build</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_TEST_API_URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to the CF Api for TEST env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>api.local.pcfdev.io</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_STAGE_API_URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to the CF Api for STAGE env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>api.local.pcfdev.io</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_PROD_API_URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to the CF Api for PROD env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>api.local.pcfdev.io</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_TEST_ORG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the org for the test env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pcfdev-org</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_TEST_SPACE_PREFIX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefix of the name of the CF space for the test env to which the app name will be appended</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sc-pipelines-test</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_STAGE_ORG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the org for the stage env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pcfdev-org</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_STAGE_SPACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the space for the stage env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sc-pipelines-stage</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_PROD_ORG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the org for the prod env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pcfdev-org</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_PROD_SPACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the space for the prod env</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sc-pipelines-prod</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REPO_WITH_BINARIES_FOR_UPLOAD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL to repo with the deployed jars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://192.168.99.100:8081/artifactory/libs-release-local" class="bare">192.168.99.100:8081/artifactory/libs-release-local</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>M2_SETTINGS_REPO_ID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The id of server from Maven settings.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>artifactory-local</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PAAS_HOSTNAME_UUID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional suffix for the route. In a shared environment the default routes can be already taken</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The right column shows the default values for PCF Dev that we set in the <code>credentials-sample-cf.yml</code>. <code>PAAS_HOSTNAME_UUID</code> and <code>BUILD_OPTIONS</code> have no default values.</p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-build-cf">4.1.6. Build the Pipeline</h4>
<div class="paragraph">
<p>Log in (for example, for a Concourse instance running at <code>192.168.99.100</code>&#8201;&#8212;&#8201;if you do not provide any value, <code>localhost</code> is assumed). If you run the login script, it assumes that either <code>fly</code> is on your <code>PATH</code> or it is in the same folder as the script. The following example shows how to specify an IP address for the login script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./login.sh 192.168.99.100</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, run the command to create the pipeline, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./set_pipeline.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then you can create a <code>github-webhook</code> pipeline under the <code>docker</code> alias, using the provided <code>credentials.yml</code> file.
You can override these values in exactly that order (for example <code>./set-pipeline.sh some-project another-target some-other-credentials.yml</code>)</p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-run-cf">4.1.7. Run the <code>github-webhook</code> Pipeline</h4>
<div class="paragraph">
<p>The following images show the various steps involved in running the <code>github-webhook</code> pipeline:</p>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_login.png" alt="concourse login">
</div>
<div class="title">Step 1: Click <code>Login</code></div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_team_main.png" alt="concourse team main">
</div>
<div class="title">Step 2: Pick <code>main</code> team</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_user_pass.png" alt="concourse user pass">
</div>
<div class="title">Step 3: Log in with <code>concourse</code> user and <code>changeme</code> password</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_pipeline.png" alt="concourse pipeline">
</div>
<div class="title">Step 4: Your screen should look more or less like this</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/start_pipeline.png" alt="start pipeline">
</div>
<div class="title">Step 5: Unpause the pipeline by clicking in the top lefr corner and then clicking the <code>play</code> button</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/generate_version.png" alt="generate version">
</div>
<div class="title">Step 6: Click 'generate-version'</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/run_pipeline.png" alt="run pipeline">
</div>
<div class="title">Step 7: Click <code>+</code> sign to start a new build</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_pending.png" alt="concourse pending">
</div>
<div class="title">Step 8: The job is pending</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/job_running.png" alt="job running">
</div>
<div class="title">Step 9: Job is pending in the main screen</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/running_pipeline.png" alt="running pipeline">
</div>
<div class="title">Step 10: Job is running in the main screen</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concourse-pipeline-k8s">5. Concourse Pipeline (Kubernetes)</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In this chapter, we assume that you deploy your application
to Kubernetes PaaS
</td>
</tr>
</table>
</div>
<div id="concourse-k8s" class="paragraph">
<p>The Cloud Pipelines repository contains opinionated
Concourse pipeline definitions. Those jobs form an empty pipeline and an
opinionated sample pipeline that you can use in your company.</p>
</div>
<div class="paragraph">
<p>The following projects take part in the <code>microservice setup</code> for this demo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-kubernetes">Github Analytics</a>: The application that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook-kubernetes">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-eureka">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and uses Eureka and Messaging. This is an infrastructure application.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="step-by-step-k8s">5.1. Step-by-step</h3>
<div class="paragraph">
<p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#concourse-fork-k8s">Fork repos</a></p>
</li>
<li>
<p><a href="#concourse-start-k8s">Start Concourse and Artifactory</a></p>
</li>
<li>
<p><a href="#concourse-pipeline-fly-k8s">Setup the <code>fly</code> CLI </a></p>
</li>
<li>
<p><a href="#concourse-pipeline-credentials-k8s">Setup your <code>credentials.yml</code> </a></p>
</li>
<li>
<p><a href="#concourse-pipeline-build-k8s">Setup the pipeline </a></p>
</li>
<li>
<p><a href="#concourse-pipeline-run-k8s">Run the <code>github-webhook</code> pipeline</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="fork-repos-k8s">5.1.1. Fork Repositories</h4>
<div id="concourse-fork-k8s" class="paragraph">
<p>Four applications compose the pipeline:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook-kubernetes">Github Webhook</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/">Github Analytics</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-eureka">Github Eureka</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs">Github Stub Runner Boot</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to fork only the following repositories, because only then can you tag and push the tag to the repository:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-webhook-kubernetes">Github Webhook</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/">Github Analytics</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concourse-start-k8s">5.2. Concourse in K8S (Kubernetes)</h3>
<div class="paragraph">
<p>The simplest way to deploy Concourse to K8S is to use <a href="https://github.com/kubernetes/helm">Helm</a>.
Once you have Helm installed and your <code>kubectl</code> is pointing to the
cluster, run the following command to install the Concourse cluster in your K8S cluster:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ helm install stable/concourse --name concourse</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the script is done, you should see the following output</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">1. Concourse can be accessed:

  * Within your cluster, at the following DNS name at port 8080:

    concourse-web.default.svc.cluster.local

  * From outside the cluster, run these commands in the same shell:

    export POD_NAME=$(kubectl get pods --namespace default -l "app=concourse-web" -o jsonpath="{.items[0].metadata.name}")
    echo "Visit http://127.0.0.1:8080 to use Concourse"
    kubectl port-forward --namespace default $POD_NAME 8080:8080

2. Login with the following credentials

  Username: concourse
  Password: concourse</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Follow the steps and log in to Concourse under <a href="http://127.0.0.1:8080" class="bare">127.0.0.1:8080</a>.</p>
</div>
<div class="sect3">
<h4 id="deploying-artifactory-to-k8s">5.2.1. Deploying Artifactory to K8S</h4>
<div class="paragraph">
<p>You can use Helm also to deploy Artifactory to K8S, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ helm install --name artifactory --set artifactory.image.repository=docker.bintray.io/jfrog/artifactory-oss stable/artifactory</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After you run this command, you should see the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">NOTES:
Congratulations. You have just deployed JFrog Artifactory Pro!

1. Get the Artifactory URL by running these commands:

   NOTE: It may take a few minutes for the LoadBalancer IP to be available.
         You can watch the status of the service by running 'kubectl get svc -w nginx'
   export SERVICE_IP=$(kubectl get svc --namespace default nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
   echo http://$SERVICE_IP/

2. Open Artifactory in your browser
   Default credential for Artifactory:
   user: admin
   password: password</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, you need to set up the repositories.</p>
</div>
<div class="paragraph">
<p>First, access the Artifactory URL and log in with
a user name of <code>admin</code> and a password of <code>password</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/artifactory_quick_setup.png" alt="artifactory quick setup">
</div>
<div class="title">Figure 29. Click on Quick Setup</div>
</div>
<div class="paragraph">
<p>Then, click on Maven setup and click <code>Create</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/artifactory_maven_repo.png" alt="artifactory maven repo">
</div>
<div class="title">Figure 30. Create the <code>Maven</code> Repository</div>
</div>
</div>
<div class="sect3">
<h4 id="concourse-pipeline-fly-k8s">5.2.2. Setup the <code>fly</code> CLI</h4>
<div class="paragraph">
<p><a id="fly"></a> If you go to the Concourse website you should see something resembling the following:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/running_concourse.png" alt="running concourse">
</div>
</div>
<div class="paragraph">
<p>You can click one of the icons (depending on your OS) to download <code>fly</code>, which is the Concourse CLI. Once you download that (and maybe added it to your PATH, depending on your OS) you can run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">fly --version</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If <code>fly</code> is properly installed, it should print out the version.</p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-pipeline-credentials-k8s">5.2.3. Setup your <code>credentials.yml</code></h4>
<div class="paragraph">
<p>We made a sample credentials file called <code>credentials-sample-k8s.yml</code>
prepared for <code>k8s</code>. You can use it as a base for your <code>credentials.yml</code>.</p>
</div>
<div class="paragraph">
<p>To allow the Concourse worker&#8217;s spawned container to connect to the
Kubernetes cluster, you must pass the CA contents and the
auth token.</p>
</div>
<div class="paragraph">
<p>To get the contents of CA for GCE, run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ kubectl get secret $(kubectl get secret | grep default-token | awk '{print $1}') -o jsonpath='{.data.ca\.crt}' | base64 --decode</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To get the auth token, run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ kubectl get secret $(kubectl get secret | grep default-token | awk '{print $1}') -o jsonpath='{.data.token}' | base64 --decode</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Set that value under <code>paas-test-client-token</code>, <code>paas-stage-client-token</code>, and <code>paas-prod-client-token</code></p>
</div>
</div>
<div class="sect3">
<h4 id="concourse-pipeline-build-k8s">5.2.4. Build the pipeline</h4>
<div class="paragraph">
<p>After running Concourse, you should get the following output in your terminal:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ export POD_NAME=$(kubectl get pods --namespace default -l "app=concourse-web" -o jsonpath="{.items[0].metadata.name}")
$ echo "Visit http://127.0.0.1:8080 to use Concourse"
$ kubectl port-forward --namespace default $POD_NAME 8080:8080
Visit http://127.0.0.1:8080 to use Concourse</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Log in (for example, for Concourse running at <code>127.0.0.1</code>&#8201;&#8212;&#8201;if you do not provide any value, <code>localhost</code> is assumed). If you run this script, it assumes that either <code>fly</code> is on your <code>PATH</code> or that it is in the same folder as the script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ fly -t k8s login -c http://localhost:8080 -u concourse -p concourse</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, run the following command to create the pipeline:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./set_pipeline.sh github-webhook k8s credentials-k8s.yml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concourse-pipeline-run-k8s">5.2.5. Run the <code>github-webhook</code> Pipeline</h4>
<div class="paragraph">
<p>The following images show the various steps involved in runnig the <code>github-webhook</code> pipeline:</p>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_login.png" alt="concourse login">
</div>
<div class="title">Step 1: Click <code>Login</code></div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_team_main.png" alt="concourse team main">
</div>
<div class="title">Step 2: Pick <code>main</code> team</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_user_pass.png" alt="concourse user pass">
</div>
<div class="title">Step 3: Log in with <code>concourse</code> user and <code>concourse</code> password</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_pipeline.png" alt="concourse pipeline">
</div>
<div class="title">Step 4: Your screen should look more or less like this</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/start_pipeline.png" alt="start pipeline">
</div>
<div class="title">Step 5: Unpause the pipeline by clicking in the top lefr corner and then clicking the <code>play</code> button</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/generate_version.png" alt="generate version">
</div>
<div class="title">Step 6: Click 'generate-version'</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/run_pipeline.png" alt="run pipeline">
</div>
<div class="title">Step 7: Click <code>+</code> sign to start a new build</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/concourse_pending.png" alt="concourse pending">
</div>
<div class="title">Step 8: The job is pending</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/job_running.png" alt="job running">
</div>
<div class="title">Step 9: Job is pending in the main screen</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/concourse/running_pipeline.png" alt="running pipeline">
</div>
<div class="title">Step 10: Job is running in the main screen</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes-setup">6. Kubernetes Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to set up Kubernetes.</p>
</div>
<div class="sect2">
<h3 id="kubernetes-cli-installation">6.1. Kubernetes CLI Installation</h3>
<div class="paragraph">
<p>First, you need to install the <code>kubectl</code> command-line interface (CLI).</p>
</div>
<div class="sect3">
<h4 id="kubernetes-cli-script">6.1.1. Script Installation</h4>
<div class="paragraph">
<p>You can use the <code>tools/k8s-helper.sh</code> script to install <code>kubectl</code>. To do so, run the following script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./tools/minikube-helper download-kubectl</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then the <code>kubectl</code> gets downloaded.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-cli-manual">6.1.2. Manual Installation</h4>
<div class="paragraph">
<p>You can perform a manual installation for either OSX or Linux.</p>
</div>
<div class="sect4">
<h5 id="example-for-osx">Example for OSX</h5>
<div class="paragraph">
<p>The following listing shows how to manually install on OSX:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
----</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="example-for-linux">Example for Linux</h5>
<div class="paragraph">
<p>The following listing shows how to manually install on Linux:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">this page</a> for more information.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="start-minikube-k8s">6.2. Kubernetes Cluster Setup</h3>
<div class="paragraph">
<p>We need a cluster of Kubernetes. The best choice is <a href="https://github.com/kubernetes/minikube">Minikube</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can skip this step if you have a Kubernetes cluster installed and do not
want to use Minikube. In that case, the only thing you have to do is to set up spaces.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Servers often run run out of resources at the stage step.
If that happens, <a href="#jenkins-resources-k8s">clear some apps from PCF Dev and continue</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="kubernetes-minikube-script">6.2.1. Script Installation</h4>
<div class="paragraph">
<p>You can use the <code>tools/k8s-helper.sh</code> script to install <code>Minikube</code>. To do so, run the following script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./tools/minikube-helper download-minikube</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then the <code>Minikube</code> cluster gets downloaded.</p>
</div>
</div>
<div class="sect3">
<h4 id="kubernetes-minikube-manual">6.2.2. Manual Installation</h4>
<div class="paragraph">
<p>You can perform a manual installation for either OSX or Linux.</p>
</div>
<div class="sect4">
<h5 id="example-for-osx-2">Example for OSX</h5>
<div class="paragraph">
<p>The following listing shows how to manually install on OSX:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.20.0/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Feel free to skip running <code>sudo mv minikube /usr/local/bin</code> if you want to add minikube to your path manually.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-for-linux-2">6.2.3. Example for Linux</h4>
<div class="paragraph">
<p>The following listing shows how to manually install on Linux:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.20.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can skip running <code>sudo mv minikube /usr/local/bin</code> if you want to add minikube to your path manually.
See <a href="https://github.com/kubernetes/minikube/releases">this page</a> for more information on the installation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-minikube">6.3. Run Minikube</h3>
<div class="paragraph">
<p>To start Kubernetes on your local box, run <code>minikube start</code>.</p>
</div>
<div class="paragraph">
<p>To add the dashboard, run <code>minikube dashboard</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="certificates-and-workers">6.4. Certificates and Workers</h3>
<div class="sect3">
<h4 id="minikube-certificates-and-workers">6.4.1. Minikube Certificates and Workers</h4>
<div class="paragraph">
<p>By default, if you install Minikube, all the certificates get installed in your
<code>~/.minikube</code> folder. Your <code>kubectl</code> configuration under <code>~/.kube/config</code> also
gets updated to use Minikube.</p>
</div>
</div>
<div class="sect3">
<h4 id="manual-certificates-and-workers-setup">6.4.2. Manual Certificates and Workers Setup</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to run the default demo setup, you can skip this section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To target a given Kubernetes instance, you need to pass around Certificate Authority
key and also user keys.</p>
</div>
<div class="paragraph">
<p>You can read more about the instructions on how to generate those keys <a href="https://coreos.com/kubernetes/docs/latest/openssl.html">here</a>.
Generally speaking, if you have a Kubernetes installation (such as <code>minikube</code>), this step
has already been done for you. Now you can reuse those keys on the workers.</p>
</div>
<div class="paragraph">
<p>The following inormation has been extracted from the <a href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html">Kubernetes official documentation</a>.</p>
</div>
<div class="paragraph">
<p>Configure <code>kubectl</code> to connect to the target cluster using the following commands, replacing the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>${MASTER_HOST}</code> with the master node address or name used in previous steps.</p>
</li>
<li>
<p>Replace <code>${CA_CERT}</code> with the absolute path to the <code>ca.pem</code> created in previous steps.</p>
</li>
<li>
<p>Replace <code>${ADMIN_KEY}</code> with the absolute path to the <code>admin-key.pem</code> created in previous steps.</p>
</li>
<li>
<p>Replace <code>${ADMIN_CERT}</code> with the absolute path to the <code>admin.pem</code> created in previous steps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following commands show how to perform these steps:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ kubectl config set-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config set-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config set-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generate-minikube-namespaces">6.5. Generate Minikube Namespaces</h3>
<div class="paragraph">
<p>With the Minikube cluster running, we need to generate namespaces. To do so, run the
<code>./tools/k8s-helper.sh setup-namespaces</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-demo-setup-cloud-foundry">7. The demo setup (Cloud Foundry)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The demo uses two applications: <a href="https://github.com/spring-cloud-samples/github-webhook/">Github Webhook</a>
and <a href="https://github.com/spring-cloud-samples/github-analytics/">Github analytics code</a>. The following
image shows how these application communicate with each other:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo.png" alt="demo">
</div>
<div class="title">The overview of the demo: Github Webhook listens to HTTP calls and sends a message to Github Analytics</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p>For the demo scenario we have two applications. <code>Github Analytics</code> and <code>Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code>Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code>Github Webhook</code> sends a message by RabbitMQ to a channel. <code>Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo_metrics.png" alt="demo metrics">
</div>
<div class="title">Gathering metrics: Github Analytics exposes metrics that are polled by Prometheus</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p><code>Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo_alerting.png" alt="demo alerting">
</div>
<div class="title">Alerting over metrics: Grafana alerts Slack over Prometheus metrics</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p>
</div>
<div class="sect2">
<h3 id="deploying-production-applications-to-pcf-dev">7.1. Deploying Production Applications to PCF Dev</h3>
<div class="paragraph">
<p>In a real-world scenario, we would not want to automatically provision services such as
RabbitMQ, MySQL, or Eureka each time we deploy a new application to production. Typically,
production is provisioned manually (often by using automated solutions). In our case, before
you deploy to production, you can provision the <code>pcfdev-prod</code> space by using the
 <code>cf-helper.sh</code>. To do so, call the following script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./cf-helper.sh setup-prod-infra</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The CF CLI:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logs in to PCF Dev,</p>
</li>
<li>
<p>Targets the <code>pcfdev-prod</code> space</p>
</li>
<li>
<p>Sets up:</p>
<div class="ulist">
<ul>
<li>
<p>RabbitMQ (under the <code>rabbitmq-github</code> name)</p>
</li>
<li>
<p>MySQL (under <code>mysql-github-analytics</code> name)</p>
</li>
<li>
<p>Eureka (under <code>github-eureka</code> name)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="running-prometheus-on-cf">7.2. Running Prometheus on CF</h3>
<div class="paragraph">
<p>You can check out <a href="https://github.com/making/prometheus-on-PCF">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p>
</div>
<div class="paragraph">
<p>Go to <a href="https://prometheus.io/download/" class="bare">prometheus.io/download/</a> and download the Linux binary. Then run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf push sc-pipelines-prometheus -b binary_buildpack -c './prometheus -web.listen-address=:8080' -m 64m</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Also, <code>localhost:9090</code> in <code>prometheus.yml</code> should be <code>localhost:8080</code>.</p>
</div>
<div class="paragraph">
<p>The file should resemble the following listing to work with the demo setup (change <code>github-analytics-sc-pipelines.cfapps.io</code>
to your <code>github-analytics</code> installation).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml"># my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
      monitor: 'codelab-monitor'

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first.rules"
  # - "second.rules"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:8080']

  - job_name: 'demo-app'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    metrics_path: '/prometheus'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['github-analytics-sc-pipelines.cfapps.io']</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A deployed version for the Cloud Pipelines demo is available <a href="https://sc-pipelines-prometheus.cfapps.io/">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="running-grafana-on-cf">7.3. Running Grafana on CF</h3>
<div class="paragraph">
<p>You can check out <a href="https://github.com/making/cf-grafana">Toshiaki Maki&#8217;s code</a> to see how to automate Prometheus installation on CF.</p>
</div>
<div class="paragraph">
<p>Download the tarball from <a href="https://grafana.com/grafana/download?platform=linux" class="bare">grafana.com/grafana/download?platform=linux</a>
and set <code>http_port = 8080</code> in <code>conf/default.ini</code>. Then run the following the command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf push sc-pipelines-grafana -b binary_buildpack -c './bin/grafana-server web' -m 64m</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The demo uses Grafana Dashboard with an ID of <code>2471</code>.</p>
</div>
<div class="paragraph">
<p>A deployed version for the Cloud Pipelines demo is available <a href="https://sc-pipelines-grafana.cfapps.io/">here</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-demo-setup-kubernetes">8. The demo setup (Kubernetes)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The demo uses two applications: <a href="https://github.com/spring-cloud-samples/github-webhook-kubernetes/">Github Webhook</a>
and <a href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/">Github analytics code</a>. The following
image shows how these application communicate with each other:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo.png" alt="demo">
</div>
<div class="title">The overview of the demo: Github Webhook listens to HTTP calls and sends a message to Github Analytics</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p>For the demo scenario we have two applications. <code>Github Analytics</code> and <code>Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code>Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code>Github Webhook</code> sends a message by RabbitMQ to a channel. <code>Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo_metrics.png" alt="demo metrics">
</div>
<div class="title">Gathering metrics: Github Analytics exposes metrics that are polled by Prometheus</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p><code>Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/CloudPipelines/concourse/master/docs/images/demo/demo_alerting.png" alt="demo alerting">
</div>
<div class="title">Alerting over metrics: Grafana alerts Slack over Prometheus metrics</div>
</div>
<div class="paragraph">
<p>&#160;
&#160;</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p>
</div>
<div class="sect2">
<h3 id="deploying-production-applications-to-minikube">8.1. Deploying Production Applications to Minikube</h3>
<div class="paragraph">
<p>In a real-world scenario, we would not want to automatically provision services such as
RabbitMQ, MySQL, or Eureka each time we deploy a new application to production. Typically,
production is provisioned manually (often by using automated solutions). In our case, before
you deploy to production, you can provision the <code>sc-pipelines-prod</code> namespace by using the
 <code>k8s-helper.sh</code>. To do so, call the following script:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./k8s-helper.sh setup-prod-infra</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-prometheus-on-kubernetes">8.2. Running Prometheus on Kubernetes</h3>
<div class="paragraph">
<p>Use Helm to install Prometheus. Later in this demo, we point it to the services
deployed to our cluster.</p>
</div>
<div class="paragraph">
<p>Create a file called <code>values.yaml</code> with the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. values.yaml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">rbac:
  create: false

alertmanager:
  ## If false, alertmanager will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## alertmanager container name
  ##
  name: alertmanager

  ## alertmanager container image
  ##
  image:
    repository: prom/alertmanager
    tag: v0.9.1
    pullPolicy: IfNotPresent

  ## Additional alertmanager container arguments
  ##
  extraArgs: {}

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional alertmanager container environment variable
  ## For instance to add a http_proxy
  ##
  extraEnv: {}

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.alertmanager.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/alertmanager-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, alertmanager Ingress will be created
    ##
    enabled: false

    ## alertmanager Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## alertmanager Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - alertmanager.domain.com

    ## alertmanager Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - alertmanager.domain.com

  ## Alertmanager Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node labels for alertmanager pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  persistentVolume:
    ## If true, alertmanager will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## alertmanager data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## alertmanager data Persistent Volume Claim annotations
    ##
    annotations: {}

    ## alertmanager data Persistent Volume existing claim name
    ## Requires alertmanager.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## alertmanager data Persistent Volume mount root path
    ##
    mountPath: /data

    ## alertmanager data Persistent Volume size
    ##
    size: 2Gi

    ## alertmanager data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of alertmanager data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to alertmanager pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## alertmanager resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the alertmanager service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    # nodePort: 30000
    type: ClusterIP

## Monitors ConfigMap changes and POSTs to a URL
## Ref: https://github.com/jimmidyson/configmap-reload
##
configmapReload:
  ## configmap-reload container name
  ##
  name: configmap-reload

  ## configmap-reload container image
  ##
  image:
    repository: jimmidyson/configmap-reload
    tag: v0.1
    pullPolicy: IfNotPresent

  ## configmap-reload resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}

kubeStateMetrics:
  ## If false, kube-state-metrics will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## kube-state-metrics container name
  ##
  name: kube-state-metrics

  ## kube-state-metrics container image
  ##
  image:
    repository: gcr.io/google_containers/kube-state-metrics
    tag: v1.1.0-rc.0
    pullPolicy: IfNotPresent

  ## Node labels for kube-state-metrics pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to kube-state-metrics pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## kube-state-metrics resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 16Mi
    # requests:
    #   cpu: 10m
    #   memory: 16Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the kube-state-metrics service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

nodeExporter:
  ## If false, node-exporter will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## node-exporter container name
  ##
  name: node-exporter

  ## node-exporter container image
  ##
  image:
    repository: prom/node-exporter
    tag: v0.15.0
    pullPolicy: IfNotPresent

  ## Additional node-exporter container arguments
  ##
  extraArgs: {}

  ## Additional node-exporter hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: textfile-dir
    #   mountPath: /srv/txt_collector
    #   hostPath: /var/lib/node-exporter
    #   readOnly: true

  ## Node tolerations for node-exporter scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for node-exporter pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to node-exporter pods
  ##
  podAnnotations: {}

  ## node-exporter resource limits &amp; requests
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 200m
    #   memory: 50Mi
    # requests:
    #   cpu: 100m
    #   memory: 30Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the node-exporter service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    hostPort: 9100
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9100
    type: ClusterIP

server:
  ## Prometheus server container name
  ##
  name: server

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## Prometheus server container image
  ##
  image:
    repository: prom/prometheus
    tag: v1.8.0
    pullPolicy: IfNotPresent

  ## (optional) alertmanager URL
  ## only used if alertmanager.enabled = false
  alertmanagerURL: ""

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional Prometheus server container arguments
  ##
  extraArgs: {}

  ## Additional Prometheus server hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: certs-dir
    #   mountPath: /etc/kubernetes/certs
    #   hostPath: /etc/kubernetes/certs
    #   readOnly: true

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.server.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/server-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, Prometheus server Ingress will be created
    ##
    enabled: false

    ## Prometheus server Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## Prometheus server Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - prometheus.domain.com

    ## Prometheus server Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-server-tls
    #     hosts:
    #       - prometheus.domain.com

  ## Server Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node tolerations for server scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for Prometheus server pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  nodeSelector: {}

  persistentVolume:
    ## If true, Prometheus server will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## Prometheus server data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## Prometheus server data Persistent Volume annotations
    ##
    annotations: {}

    ## Prometheus server data Persistent Volume existing claim name
    ## Requires server.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## Prometheus server data Persistent Volume mount root path
    ##
    mountPath: /data

    ## Prometheus server data Persistent Volume size
    ##
    size: 8Gi

    ## Prometheus server data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of Prometheus server data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to Prometheus server pods
  ##
  podAnnotations: {}
    # iam.amazonaws.com/role: prometheus

  replicaCount: 1

  ## Prometheus server resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the Prometheus server service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

  ## Prometheus server pod termination grace period
  ##
  terminationGracePeriodSeconds: 300

  ## Prometheus data retention period (i.e 360h)
  ##
  retention: ""

pushgateway:
  ## If false, pushgateway will not be installed
  ##
  enabled: true

  ## pushgateway container name
  ##
  name: pushgateway

  ## pushgateway container image
  ##
  image:
    repository: prom/pushgateway
    tag: v0.4.0
    pullPolicy: IfNotPresent

  ## Additional pushgateway container arguments
  ##
  extraArgs: {}

  ingress:
    ## If true, pushgateway Ingress will be created
    ##
    enabled: false

    ## pushgateway Ingress annotations
    ##
    annotations:
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## pushgateway Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - pushgateway.domain.com

    ## pushgateway Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - pushgateway.domain.com

  ## Node labels for pushgateway pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to pushgateway pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## pushgateway resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations:
      prometheus.io/probe: pushgateway
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the pushgateway service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9091
    type: ClusterIP

## alertmanager ConfigMap entries
##
alertmanagerFiles:
  alertmanager.yml: |-
    global:
      # slack_api_url: ''
    receivers:
      - name: default-receiver
        # slack_configs:
        #  - channel: '@you'
        #    send_resolved: true
    route:
      group_wait: 10s
      group_interval: 5m
      receiver: default-receiver
      repeat_interval: 3h
## Prometheus server ConfigMap entries
##
serverFiles:
  alerts: ""
  rules: ""

  prometheus.yml: |-
    rule_files:
      - /etc/config/rules
      - /etc/config/alerts
    scrape_configs:
      - job_name: 'demo-app'
        scrape_interval: 5s
        metrics_path: '/prometheus'
        static_configs:
          - targets:
            - github-analytics.sc-pipelines-prod.svc.cluster.local:8080
      - job_name: prometheus
        static_configs:
          - targets:
            - localhost:9090
      # A scrape configuration for running Prometheus on a Kubernetes cluster.
      # This uses separate scrape configs for cluster components (i.e. API server, node)
      # and services to allow each to use different authentication configs.
      #
      # Kubernetes labels will be added as Prometheus labels on metrics via the
      # `labelmap` relabeling action.
      # Scrape config for API servers.
      #
      # Kubernetes exposes API servers as endpoints to the default/kubernetes
      # service so this uses `endpoints` role and uses relabelling to only keep
      # the endpoints associated with the default/kubernetes service using the
      # default named port `https`. This works for single API server deployments as
      # well as HA API server deployments.
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
          - role: endpoints
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # Keep only the default/kubernetes service endpoints for the https port. This
        # will add targets for each API server which Kubernetes adds an endpoint to
        # the default/kubernetes service.
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: default;kubernetes;https
      - job_name: 'kubernetes-nodes'
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics
      # Scrape config for service endpoints.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape services that have a value of `true`
      # * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need
      # to set this to `https` &amp; most likely set the `tls_config` of the scrape config.
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: If the metrics are exposed on a different port to the
      # service then set this appropriately.
      - job_name: 'kubernetes-service-endpoints'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
            action: replace
            target_label: __scheme__
            regex: (https?)
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+)(?::\d+);(\d+)
            replacement: $1:$2
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name
      - job_name: 'prometheus-pushgateway'
        honor_labels: true
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: pushgateway
      # Example scrape config for probing services via the Blackbox Exporter.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/probe`: Only probe services that have a value of `true`
      - job_name: 'kubernetes-services'
        metrics_path: /probe
        params:
          module: [http_2xx]
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: true
          - source_labels: [__address__]
            target_label: __param_target
          - target_label: __address__
            replacement: blackbox
          - source_labels: [__param_target]
            target_label: instance
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            target_label: kubernetes_name
      # Example scrape config for pods
      #
      # The relabeling allows the actual pod scrape endpoint to be configured via the
      # following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape pods that have a value of `true`
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: Scrape the pod on the indicated port instead of the default of `9102`.
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: (.+):(?:\d+);(\d+)
            replacement: ${1}:${2}
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
networkPolicy:
  ## Enable creation of NetworkPolicy resources.
  ##
  enabled: false</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, create the prometheus installation with the predefined values. To do so, run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ helm install --name sc-pipelines-prometheus stable/prometheus -f values.yaml</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then you should see the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">NOTES:
The Prometheus server can be accessed via port 80 on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local


Get the Prometheus server URL by running these commands in the same shell:
  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=server" -o jsonpath="{.items[0].metadata.name}")
  kubectl --namespace default port-forward $POD_NAME 9090


The Prometheus alertmanager can be accessed via port 80 on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-alertmanager.default.svc.cluster.local


Get the Alertmanager URL by running these commands in the same shell:
  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=alertmanager" -o jsonpath="{.items[0].metadata.name}")
  kubectl --namespace default port-forward $POD_NAME 9093


The Prometheus PushGateway can be accessed via port 9091 on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-pushgateway.default.svc.cluster.local


Get the PushGateway URL by running these commands in the same shell:
  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=pushgateway" -o jsonpath="{.items[0].metadata.name}")
  kubectl --namespace default port-forward $POD_NAME 9093

For more information on running Prometheus, visit:
https://prometheus.io/</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-grafana-on-kubernetes">8.3. Running Grafana on Kubernetes</h3>
<div class="paragraph">
<p>Use Helm to install Grafana, by running the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ helm install --name sc-pipelines-grafana stable/grafana</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should see the following output:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">NOTES:
1. Get your 'admin' user password by running:

   kubectl get secret --namespace default sc-pipelines-grafana-grafana -o jsonpath="{.data.grafana-admin-password}" | base64 --decode ; echo

2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:

   sc-pipelines-grafana-grafana.default.svc.cluster.local

   Get the Grafana URL to visit by running these commands in the same shell:

     export POD_NAME=$(kubectl get pods --namespace default -l "app=sc-pipelines-grafana-grafana,component=grafana" -o jsonpath="{.items[0].metadata.name}")
     kubectl --namespace default port-forward $POD_NAME 3000

3. Login with the password from step 1 and the username: admin</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Perform the steps listed in the preceding output and add the Grafana&#8217;s datasource
as Prometheus with the following URL: <code><a href="http://sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local" class="bare">sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local</a></code></p>
</div>
<div class="paragraph">
<p>You can pick up the dashboard with the Grafana ID (2471). This is the
default dashboard for the Cloud Pipelines demo apps.</p>
</div>
<div class="paragraph">
<p>If you have both apps (<code>github-webhook</code> and <code>github-analytics</code>) running on production,
you can now trigger the messages. Download the JSON with a sample request
from <a href="https://github.com/marcingrzejszczak/github-webhook-kubernetes/blob/master/src/test/resources/github-webhook-input/hook-created.json">the github-webhook repository</a>.
Next, pick one of the <code>github-webhook</code> pods and forward its port
locally to a port <code>9876</code>, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ kubectl port-forward --namespace=sc-pipelines-prod $( kubectl get pods --namespace=sc-pipelines-prod | grep github-webhook | head -1 | awk '{print $1}' ) 9876:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, send a couple of requests (more than four), by using cURL as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl -X POST http://localhost:9876/ -d @path/to/issue-created.json \
--header "Content-Type: application/json"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then, if you use Grafana, you can see that you went above the threshold.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-the-project">9. Building the Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers how to build the project. It covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#building-project-setup">Project Setup</a></p>
</li>
<li>
<p><a href="#building-prerequisites">Prerequisites</a></p>
</li>
<li>
<p><a href="#building-bats-submodules">Bats Submodules</a></p>
</li>
<li>
<p><a href="#building-build-and-test">Build and test</a></p>
</li>
<li>
<p><a href="#building-generate-documentation">Generate Documentation</a></p>
</li>
<li>
<p><a href="#building-making-a-release">Releasing the Project</a></p>
</li>
<li>
<p><a href="#building-ci-worker-prerequisites">CI Server Worker Prerequisites</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="building-project-setup">9.1. Project Setup</h3>

</div>
<div class="sect2">
<h3 id="building-prerequisites">9.2. Prerequisites</h3>
<div class="paragraph">
<p>As prerequisites, you need to have <a href="http://www.shellcheck.net/">shellcheck</a>,
<a href="https://github.com/sstephenson/bats">bats</a>, <a href="https://stedolan.github.io/jq/">jq</a>
and <a href="https://rubyinstaller.org/downloads/">ruby</a> installed. If you use a Linux
machine, <code>bats</code> and <code>shellcheck</code> are installed for you.</p>
</div>
<div class="paragraph">
<p>To install the required software on Linux, type the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ sudo apt-get install -y ruby jq</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you use a Mac, run the following commands to install the missing software:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ brew install jq
$ brew install ruby
$ brew install bats
$ brew install shellcheck</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-bats-submodules">9.3. Bats Submodules</h3>
<div class="paragraph">
<p>To make <code>bats</code> work properly, we needed to attach Git submodules. To have them
initialized, either clone the project or (if you have already cloned the project)
pull to update it. The following command clones the project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ git clone --recursive https://github.com/cloudpipelines/jenkins.git</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following commands pull the project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ git submodule init
$ git submodule update</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you forget about this step, Gradle runs these steps for you.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-build-and-test">9.4. Build and test</h3>
<div class="paragraph">
<p>Once you have installed all the prerequisites, you can run the following command to build and test the project:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./gradlew clean build</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-generate-documentation">9.5. Generate Documentation</h3>
<div class="paragraph">
<p>To generate the documentation, run the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ ./gradlew generateDocs</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-making-a-release">10. Releasing the Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers how to release the project by publishing a Docker image.</p>
</div>
<div class="sect2">
<h3 id="publishing-a-docker-image">10.1. Publishing A Docker Image</h3>
<div class="paragraph">
<p>When doing a release, you also need to push a Docker image to Dockerhub.
From the project root, run the following commands, replacing <code>&lt;version&gt;</code> with the
version of the release:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ docker login
$ docker build -t cloudpipelines/cloud-pipelines-jenkins:&lt;version&gt; ./jenkins
$ docker push cloudpipelines/cloud-pipelines-jenkins:&lt;version&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-ci-worker-prerequisites">11. CI Server Worker Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cloud Pipelines uses Bash scripts extensively. The following list shows the software
that needs to be installed on a CI server worker for the build to pass:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"> apt-get -y install \
    bash \
    git \
    tar \
    zip \
    curl \
    ruby \
    wget \
    unzip \
    python \
    jq</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the demo setup all of these libraries are already installed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concourse-faq">12. Concourse FAQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers the most commonly asked questions about using Concourse with Cloud Pipelines:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Can I use the pipeline for some other repos?</dt>
<dd>
<p>Yes To do so, change the <code>app-url</code> in <code>credentials.yml</code>!</p>
</dd>
<dt class="hdlist1">Does this work for ANY project out of the box?</dt>
<dd>
<p>Not really. This is an <code>opinionated pipeline</code>. That is why we took some
opinionated decisions. See the documentation to learn
what those decisions are.</p>
</dd>
<dt class="hdlist1">Can I modify this to reuse in my project?</dt>
<dd>
<p>Yes It is an open-source project. The important thing is that the core part of the logic is written in
Bash scripts. That way, in the majority of cases, you could change only the bash scripts without changing the
whole pipeline. <a href="https://github.com/spring-cloud/spring-cloud-pipelines/tree/master/common/src/main/bash">You can check out the scripts here.</a></p>
<div class="paragraph">
<p>Furthermore, if you want only to customize a particular function under <code>common/src/main/bash</code>, you can provide your own
function under <code>common/src/main/bash/&lt;some custom identifier&gt;</code> where <code>&lt;some custom identifier&gt;</code> is equal to the value of
the <code>CUSTOM_SCRIPT_IDENTIFIER</code> environment variable. It defaults to <code>custom</code>.</p>
</div>
</dd>
<dt class="hdlist1">I ran out of resources! (PCF Dev)</dt>
<dd>
<p><a id="resources"></a> When deploying the application to stage or prod, you can get an <code>Insufficient resources</code> exception. The way to
resolve it is to kill some apps from the test or stage environment. To do so, run the following commands:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cf target -o pcfdev-org -s pcfdev-test
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also run <code>./tools/cf-helper.sh kill-all-apps</code> to remove
all demo-related apps deployed to PCF Dev.</p>
</div>
</dd>
<dt class="hdlist1">The rollback step fails due to a missing JAR.</dt>
<dd>
<p>You must have pushed some tags and must have also removed the Artifactory volume that
contained them. To fix this, remove the tags by running the following command:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">git tag -l | xargs -n 1 git push --delete origin</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Can I see the output of a job from the terminal?</dt>
<dd>
<p>Yes. Assuming that pipeline name is <code>github-webhook</code> and the job name is
<code>build-and-upload</code> you can see the output by running the following command:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">fly watch --job github-webhook/build-and-upload -t docker</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">I clicked the job and it is constantly pending.</dt>
<dd>
<p>Most likely, you forgot to click the <code>play</code> button to
unpause the pipeline. Click the top left, expand the list of pipelines, and click
the <code>play</code> button next to <code>github-webhook</code>.</p>
<div class="paragraph">
<p>Another problem that might occur is that you need to have the <code>version</code> branch.
Concourse waits for the <code>version</code> branch to appear in your repository. So, for
the pipeline to start, ensure that when doing some git operations, you have not
forgotten to create and copy the <code>version</code> branch too.</p>
</div>
</dd>
<dt class="hdlist1">The route is already in use (CF)</dt>
<dd>
<p>If you play around with Jenkins and Concourse you might end up with the routes occupied,
as indicated by a message similar to the following:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Using route github-webhook-test.local.pcfdev.io
Binding github-webhook-test.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-test.local.pcfdev.io is already in use.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To fix the problem, you can delete the routes, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">yes | cf delete-route local.pcfdev.io -n github-webhook-test
yes | cf delete-route local.pcfdev.io -n github-eureka-test
yes | cf delete-route local.pcfdev.io -n stubrunner-test
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can also run the <code>./tools/cf-helper.sh delete-routes</code> script.</p>
</div>
</dd>
<dt class="hdlist1">I mm unauthorized to deploy infrastructure jars</dt>
<dd>
<p>Most likely, you forgot to update your local <code>settings.xml</code> file with Artifactory&#8217;s
setup. See <a href="#settings">this section of the docs and update your <code>settings.xml</code> file</a>.</p>
</dd>
<dt class="hdlist1">The <code>version</code> resource is broken. When I click on it, I get the following error</dt>
</dl>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">resource script '/opt/resource/check []' failed: exit status 128

stderr:
Identity added: /tmp/git-resource-private-key (/tmp/git-resource-private-key)
Cloning into '/tmp/git-resource-repo-cache'...
warning: Could not find remote branch version to clone.
fatal: Remote branch version not found in upstream origin</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That means that your repo does not have the <code>version</code> branch. You need
set it up.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-08-13 13:23:06 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>
